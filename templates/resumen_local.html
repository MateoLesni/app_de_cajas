<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Resumen Local - Sistema de Gesti√≥n de Flujo de Cajas</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/resumen_local.css') }}">

  <style>
    /* Gris fuerte en encabezados */
    .sl-section > .sl-title,
    .doc-card > .doc-head { background:#5f6672 !important; color:#fff !important; }
    .acc[aria-expanded="true"] > .sl-title { background:#5f6672 !important; color:#fff !important; }

    .grid-2col { display:grid; grid-template-columns: 1fr 380px; gap:20px; }
    .doc-card { border-radius:12px; overflow:hidden; box-shadow: 0 2px 10px rgba(0,0,0,.06); background:#fff; }
    .doc-head { padding:12px 16px; font-weight:700; display:flex; align-items:center; justify-content:space-between; }
    .doc-body { padding:12px; }

    .doc-actions { display:flex; gap:8px; align-items:center; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px; cursor:pointer; border:1px solid #cbd5e1; background:#fff; color:#334155; font-weight:700; }
    .pill--primary { border-color:#2563eb; background:#2563eb; color:#fff; }
    .icon-btn { display:inline-flex; align-items:center; justify-content:center; width:32px; height:32px; border:1px solid #cbd5e1; border-radius:8px; background:#fff; cursor:pointer; }
    .icon-btn svg, .pill .ico svg { width:16px; height:16px; display:block; }

    .doc-acc { border-bottom:1px solid #e5e7eb; }
    .doc-row { padding:10px 12px; display:flex; align-items:center; justify-content:space-between; cursor:pointer; }
    .doc-row:hover { background:#f5f6f8; }
    .doc-row .row-left { display:flex; align-items:center; gap:8px; }
    .doc-row .count { font-weight:700; padding:2px 8px; border-radius:999px; background:#eef2f7; color:#334155; }
    .doc-acc .acc-body { display:none; background:#f5f6f8; }
    .doc-acc[aria-expanded="true"] .acc-body { display:block; }

    .thumbs { display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:10px; }
    .thumb { background:#fff; border-radius:8px; overflow:hidden; border:1px solid #e5e7eb; cursor:pointer; }
    .thumb .thumb-top { position:relative; }
    .thumb img { width:100%; height:140px; object-fit:cover; display:block; }
    .thumb .thumb-actions { position:absolute; right:6px; top:6px; display:flex; gap:6px; }
    .thumb .thumb-actions .icon-btn { padding:4px 6px; font-size:12px; }
    .thumb .meta { padding:6px 8px; font-size:.85rem; color:#374151; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .media-fallback { display:none; padding:6px 8px; font-size:.85rem; background:#f1f5f9; border-top:1px solid #e5e7eb; }

    .modal { position:fixed; inset:0; background:rgba(15,23,42,.7); display:none; align-items:center; justify-content:center; z-index:9999; }
    .modal.is-open { display:flex; }
    .modal .box { background:#0b1220; max-width:min(96vw,1100px); max-height:90vh; padding:10px; border-radius:12px; position:relative; }
    .modal img { max-width:100%; max-height:82vh; display:block; margin:0 auto; }
    .modal .close { position:absolute; top:8px; right:8px; background:#111827; color:#fff; border:1px solid #374151; border-radius:8px; padding:6px 10px; cursor:pointer; }
    .modal .caption { color:#d1d5db; padding-top:8px; font-size:.9rem; text-align:center; }
    .modal .modal-actions { position:absolute; left:8px; top:8px; display:flex; gap:8px; }

    .filters { display:flex; gap:12px; align-items:flex-end; }
    .filters .form-group { display:flex; flex-direction:column; gap:4px; }
    .filters .grow { flex:1; }
    .btn { border-radius:10px; padding:10px 14px; border:1px solid #2563eb; background:#2563eb; color:#fff; font-weight:700; }
    .btn-ghost { border:1px solid #cbd5e1; background:#fff; color:#334155; }
    .muted { opacity:.7; }
    .negative-amount { color:#b91c1c; font-weight:700; }

    /* Badge de estado del local */
    .sl-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 700;
      margin-left: 12px;
      text-transform: uppercase;
    }
    .sl-badge-open {
      background: #10b981;
      color: #fff;
    }
    .sl-badge-closed {
      background: #ef4444;
      color: #fff;
    }
  </style>
</head>
<body>
  <div id="app" class="ui-scale layout">
    <!-- Sidebar -->
    <aside class="sidebar" role="navigation" aria-label="Barra lateral">
      <div class="sidebar__brand">
        <div class="brand-mark" aria-hidden="true">NG</div>
        <div class="brand-meta"><strong>Sistema</strong><span>Gesti√≥n de Flujo de Cajas</span></div>
      </div>

      <nav class="sidebar__nav">
        <a class="nav-item is-active" href="{{ url_for('resumen_local') }}"><span class="nav-dot"></span>Resumen Local</a>
        <a class="nav-item" href="{{ url_for('index') }}"><span class="nav-dot"></span>Carga de Datos</a>
        {% if session.get('role_level', 1)|int >= 2 %}
        <a class="nav-item" href="{{ url_for('gestion_usuarios') }}"><span class="nav-dot"></span>Gesti√≥n de Usuarios</a>
        {% endif %}
        <div class="nav-group">
          <a href="javascript:void(0)" id="navReportes" class="nav-item nav-toggle">
            <span class="nav-dot"></span>Reporter√≠a
            <svg class="nav-caret" width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" fill="none"><polyline points="6 9 12 15 18 9"/></svg>
          </a>
          <div class="nav-sub">
            <a class="nav-item nav-sub-item" href="{{ url_for('ui_reporteria_remesas') }}"><span class="nav-dot"></span>Remesas</a>
          </div>
        </div>
      </nav>

      <div class="sidebar__footer"><a class="nav-ghost" href="{{ url_for('logout') }}">Cerrar Sesi√≥n</a></div>
      <button class="sidebar__toggle" id="toggleSidebar" aria-label="Abrir/cerrar men√∫">‚ò∞</button>
    </aside>

    <!-- Main -->
    <main class="main">
      <!-- Bot√≥n hamburguesa flotante para mobile -->
      <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Abrir men√∫">
        <span class="hamburger-icon"></span>
      </button>

      <div class="container">
        <!-- Filtros -->
        <div class="filters" style="margin-bottom:16px;">
          <div class="form-group">
            <label for="rl-fecha">Fecha</label>
            <input type="date" id="rl-fecha">
          </div>

          {% if session.get('role_level',1) | int >= 3 %}
          {# Auditor: select con todos los locales #}
          <div class="form-group grow">
            <label for="rl-local-select">Local</label>
            <select id="rl-local-select"></select>
          </div>
          {% elif session.get('role_level',1) | int == 2 and session.get('available_locales')|length > 1 %}
          {# Encargado con m√∫ltiples locales: select con sus locales asignados #}
          <div class="form-group grow">
            <label for="rl-local-select">Local</label>
            <select id="rl-local-select">
              {% for local in session.get('available_locales', []) %}
                <option value="{{ local|trim|e }}" {% if local == session.get('local') %}selected{% endif %}>
                  {{ local|trim|e }}
                </option>
              {% endfor %}
            </select>
          </div>
          {% else %}
          {# Cajero o Encargado con un solo local: campo readonly #}
          <div class="form-group grow">
            <label>Local</label>
            <input id="rl-local-inline" type="text" value="{{ session['local'] }}" readonly>
          </div>
          {% endif %}

          <div class="form-group"><button id="rl-actualizar" class="btn">Actualizar</button></div>
          <div class="form-group"><button id="rl-imprimir" class="btn btn-ghost">Imprimir</button></div>

          {% if session.get('role_level',1) | int >= 2 %}
          <div class="form-group">
            <button id="rl-toggle-source" class="btn" data-role-level="{{ session.get('role_level',1) }}" style="background-color:#6366f1;" title="Alternar entre vista de Operaci√≥n (snap) y Administraci√≥n (tablas reales)">
              <span id="rl-toggle-label">üìä Administraci√≥n</span>
            </button>
          </div>
          {% endif %}

          {% if session.get('role_level',1) | int >= 3 %}
          <div class="form-group">
            <button id="rl-marcar-auditado" class="btn" style="display:none; background-color:#ff9800;">üîí Marcar Auditado</button>
          </div>
          <div class="form-group">
            <button id="rl-carga-masiva" class="btn" style="display:none; background-color:#4caf50;">üìã Carga Masiva</button>
          </div>
          {% endif %}
        </div>

        <!-- 2 columnas -->
        <div class="grid-2col">
          <!-- Izquierda: acordeones num√©ricos -->
          <section>
            <section class="sl-panel" aria-labelledby="sl-title">
              <header class="sl-head">
                <h1 id="sl-title">Cierre Global del D√≠a
                  <span id="rl-badge-estado" class="sl-badge" style="display:none;"></span>
                </h1>
                <div class="sl-meta">
                  <div><strong>Fecha:</strong> <span id="rl-fecha-display">‚Äî</span></div>
                  <div><strong>Hora:</strong> <span id="rl-hora-display">‚Äî</span></div>
                  <div><strong>Local:</strong> <span id="rl-local-display">{{ session['local'] }}</span></div>
                </div>
              </header>

              <div class="sl-body">
                <!-- RESUMEN -->
                <section class="sl-section acc" aria-expanded="true">
                  <div class="sl-title">Resumen</div>
                  <div class="acc-body">
                    <table class="sl-table">
                      <tr><td>Venta Total</td><td class="r" id="rl-venta-total">0,00</td></tr>
                      <tr><td>Total Cobrado</td><td class="r" id="rl-total-cobrado">0,00</td></tr>
                    </table>

                    <!-- Diferencia - Acorde√≥n -->
                    <div class="sub-acc acc" aria-expanded="false">
                      <div class="sl-row sl-total"><span class="label">Diferencia</span><span class="amount r" id="rl-diferencia">0,00</span></div>
                      <div class="acc-body">
                        <div id="rl-diferencias-descargos"></div>
                      </div>
                    </div>
                  </div>
                </section>

                <!-- FACTURAS -->
                <section class="sl-section acc" aria-expanded="true">
                  <div class="sl-title">Facturas</div>
                  <div class="acc-body">
                    <!-- Ventas Z -->
                    <div class="sub-acc acc" aria-expanded="false">
                      <div class="sl-row"><span class="label">Ventas Z</span><span class="amount r" id="rl-vz-total">0,00</span></div>
                      <div class="acc-body">
                        <table class="sl-table">
                          <thead><tr><th>Z (PV-N√∫mero)</th><th class="r">Monto</th></tr></thead>
                          <tbody id="rl-vz-items"><tr class="muted"><td colspan="2">Sin ventas z cargadas</td></tr></tbody>
                          <tfoot><tr class="sl-total"><td>Total</td><td class="r" id="rl-vz-total-foot">0,00</td></tr></tfoot>
                        </table>
                      </div>
                    </div>

                    <!-- Facturas A -->
                    <div class="sub-acc acc" aria-expanded="false">
                      <div class="sl-row"><span class="label">Facturas A</span><span class="amount r" id="rl-fa-total">0,00</span></div>
                      <div class="acc-body">
                        <table class="sl-table">
                          <thead><tr><th>Factura A (PV-N√∫mero)</th><th class="r">Monto</th></tr></thead>
                          <tbody id="rl-fa-items"><tr class="muted"><td colspan="2">Sin facturas A cargadas</td></tr></tbody>
                          <tfoot><tr class="sl-total"><td>Total</td><td class="r" id="rl-fa-total-foot">0,00</td></tr></tfoot>
                        </table>
                      </div>
                    </div>

                    <!-- Facturas B -->
                    <div class="sub-acc acc" aria-expanded="false">
                      <div class="sl-row"><span class="label">Facturas B</span><span class="amount r" id="rl-fb-total">0,00</span></div>
                      <div class="acc-body">
                        <table class="sl-table">
                          <thead><tr><th>Factura B (PV-N√∫mero)</th><th class="r">Monto</th></tr></thead>
                          <tbody id="rl-fb-items"><tr class="muted"><td colspan="2">Sin facturas B cargadas</td></tr></tbody>
                          <tfoot><tr class="sl-total"><td>Total</td><td class="r" id="rl-fb-total-foot">0,00</td></tr></tfoot>
                        </table>
                      </div>
                    </div>

                    <table class="sl-table">
                      <tr><td>Discovery</td><td class="r" id="rl-discovery">0,00</td></tr>
                    </table>
                  </div>
                </section>

                <!-- VENTAS POR MEDIO (COMPLETO) -->
                <section class="sl-section acc" aria-expanded="true">
                  <div class="sl-title">Ventas por medio</div>
                  <div class="acc-body">

                    <!-- Efectivo -->
                    <div class="sub-acc acc" aria-expanded="false">
                      <div class="sl-row"><span class="label">Efectivo</span><span class="amount r" id="rl-cash">0,00</span></div>
                      <div class="acc-body">
                        <!-- Tabla de todas las remesas -->
                        <table class="sl-table">
                          <thead>
                            <tr>
                              <th style="text-align: center; width: 15%;">Nro Remesa</th>
                              <th style="text-align: center; width: 20%;">Nro Precinto</th>
                              <th style="text-align: center; width: 40%;">Monto</th>
                              <th style="text-align: center; width: 25%;">Retirada</th>
                            </tr>
                          </thead>
                          <tbody id="rl-remesas-items">
                            <tr class="muted"><td colspan="4" style="text-align: center;">Sin remesas‚Ä¶</td></tr>
                          </tbody>
                        </table>
                      </div>
                    </div>

                    <!-- Mercado Pago -->
                    <div class="sub-acc acc" aria-expanded="false">
                      <div class="sl-row"><span class="label">Mercado Pago</span><span class="amount r" id="rl-mp">0,00</span></div>
                      <div class="acc-body">
                        <table class="sl-table">
                          <tr><td>Tips Mercado Pago</td><td class="r" id="rl-mp-tips">0,00</td></tr>
                        </table>
                      </div>
                    </div>

                    <!-- Tarjeta -->
                    <div class="sub-acc acc" aria-expanded="false">
                      <div class="sl-row"><span class="label">Tarjeta</span><span class="amount r" id="rl-card">0,00</span></div>
                      <div class="acc-body">
                        <table class="sl-table">
                          <tr><td>VISA</td><td class="r" id="rl-tj-visa">0,00</td></tr>
                          <tr><td>VISA D√âBITO</td><td class="r" id="rl-tj-visa-deb">0,00</td></tr>
                          <tr><td>VISA PREPAGO</td><td class="r" id="rl-tj-visa-pre">0,00</td></tr>
                          <tr><td>MASTERCARD</td><td class="r" id="rl-tj-mc">0,00</td></tr>
                          <tr><td>MASTERCARD D√âBITO</td><td class="r" id="rl-tj-mc-deb">0,00</td></tr>
                          <tr><td>MASTERCARD PREPAGO</td><td class="r" id="rl-tj-mc-pre">0,00</td></tr>
                          <tr><td>CABAL</td><td class="r" id="rl-tj-cabal">0,00</td></tr>
                          <tr><td>CABAL D√âBITO</td><td class="r" id="rl-tj-cabal-deb">0,00</td></tr>
                          <tr><td>AMEX</td><td class="r" id="rl-tj-amex">0,00</td></tr>
                          <tr><td>MAESTRO</td><td class="r" id="rl-tj-maestro">0,00</td></tr>
                          <tr><td>NARANJA</td><td class="r" id="rl-tj-naranja">0,00</td></tr>
                          <tr><td>DECIDIR</td><td class="r" id="rl-tj-decidir">0,00</td></tr>
                          <tr><td>DINERS</td><td class="r" id="rl-tj-diners">0,00</td></tr>
                          <tr><td>PAGOS INMEDIATOS</td><td class="r" id="rl-tj-pagos-inm">0,00</td></tr>
                          <tr class="sl-total"><td>Total tarjetas</td><td class="r" id="rl-card-total">0,00</td></tr>
                        </table>
                      </div>
                    </div>

                    <!-- Rappi -->
                    <div class="sub-acc acc" aria-expanded="false">
                      <div class="sl-row"><span class="label">Rappi</span><span class="amount r" id="rl-rappi">0,00</span></div>
                      <div class="acc-body">
                        <table class="sl-table">
                          <tr><td>Total Rappi</td><td class="r" id="rl-rappi-det">0,00</td></tr>
                        </table>
                      </div>
                    </div>

                    <!-- PedidosYa -->
                    <div class="sub-acc acc" aria-expanded="false">
                      <div class="sl-row"><span class="label">PedidosYa</span><span class="amount r" id="rl-pedidosya">0,00</span></div>
                      <div class="acc-body">
                        <table class="sl-table">
                          <tr><td>Total PedidosYa</td><td class="r" id="rl-pedidosya-det">0,00</td></tr>
                        </table>
                      </div>
                    </div>

                    <!-- Gastos -->
                    <div class="sub-acc acc" aria-expanded="false">
                      <div class="sl-row"><span class="label">Gastos</span><span class="amount r" id="rl-gastos">0,00</span></div>
                      <div class="acc-body">
                        <table class="sl-table">
                          <tr><td>Caja chica</td><td class="r" id="rl-g-caja">0,00</td></tr>
                          <tr><td>Otros</td><td class="r" id="rl-g-otros">0,00</td></tr>
                          <tr class="sl-total"><td>Total gastos</td><td class="r" id="rl-g-total">0,00</td></tr>
                        </table>
                      </div>
                    </div>

                    <!-- Cuenta Cte. -->
                    <div class="sub-acc acc" aria-expanded="false">
                      <div class="sl-row"><span class="label">Cuenta Cte.</span><span class="amount r" id="rl-cta-cte">0,00</span></div>
                      <div class="acc-body">
                        <table class="sl-table">
                          <tr><td>Facturas CC</td><td class="r" id="rl-cta-cte-cc">0,00</td></tr>
                        </table>
                      </div>
                    </div>

                    <!-- Anticipos -->
                    <div class="sub-acc acc" aria-expanded="false">
                      <div class="sl-row"><span class="label">Anticipos</span><span class="amount r" id="rl-anticipos">0,00</span></div>
                      <div class="acc-body">
                        <table class="sl-table" id="rl-anticipos-detalle">
                          <!-- Se llena din√°micamente -->
                        </table>
                      </div>
                    </div>

                    <!-- TIPs -->
                    <div class="sub-acc acc" aria-expanded="false">
                      <div class="sl-row"><span class="label">TIPs</span><span class="amount r" id="rl-tips">0,00</span></div>
                      <div class="acc-body">
                        <table class="sl-table">
                          <tr><td>Total propinas</td><td class="r" id="rl-tips-det">0,00</td></tr>
                          <tr><td>Mercado Pago</td><td class="r" id="rl-tips-mp">0,00</td></tr>
                          <tr><td>VISA</td><td class="r" id="rl-tip-visa">0,00</td></tr>
                          <tr><td>VISA D√âBITO</td><td class="r" id="rl-tip-visa-deb">0,00</td></tr>
                          <tr><td>VISA PREPAGO</td><td class="r" id="rl-tip-visa-pre">0,00</td></tr>
                          <tr><td>MASTERCARD</td><td class="r" id="rl-tip-mc">0,00</td></tr>
                          <tr><td>MASTERCARD D√âBITO</td><td class="r" id="rl-tip-mc-deb">0,00</td></tr>
                          <tr><td>MASTERCARD PREPAGO</td><td class="r" id="rl-tip-mc-pre">0,00</td></tr>
                          <tr><td>CABAL</td><td class="r" id="rl-tip-cabal">0,00</td></tr>
                          <tr><td>CABAL D√âBITO</td><td class="r" id="rl-tip-cabal-deb">0,00</td></tr>
                          <tr><td>AMEX</td><td class="r" id="rl-tip-amex">0,00</td></tr>
                          <tr><td>MAESTRO</td><td class="r" id="rl-tip-maestro">0,00</td></tr>
                          <tr><td>NARANJA</td><td class="r" id="rl-tip-naranja">0,00</td></tr>
                          <tr><td>DECIDIR</td><td class="r" id="rl-tip-decidir">0,00</td></tr>
                          <tr><td>DINERS</td><td class="r" id="rl-tip-diners">0,00</td></tr>
                          <tr><td>PAGOS INMEDIATOS</td><td class="r" id="rl-tip-pagos-inm">0,00</td></tr>
                          <tr class="sl-total"><td>Propinas Tarjetas</td><td class="r" id="rl-tips-tarjetas">0,00</td></tr>
                        </table>
                      </div>
                    </div>

                  </div>
                </section>

                <!-- ANTICIPOS -->
                <section class="sl-section acc" aria-expanded="false">
                  <div class="sl-title">Anticipos</div>
                  <div class="acc-body">
                    <div id="rl-anticipos-loading" style="padding: 20px; text-align: center; color: #6b7280;">
                      <i class="fas fa-spinner fa-spin"></i> Cargando anticipos...
                    </div>
                    <div id="rl-anticipos-empty" style="display: none; padding: 20px; text-align: center; color: #9ca3af;">
                      No hay anticipos consumidos en este local
                    </div>
                    <table class="sl-table" id="rl-anticipos-table" style="display: none;">
                      <thead>
                        <tr>
                          <th>Fecha Evento</th>
                          <th>Cliente</th>
                          <th>Medio</th>
                          <th class="r">Importe</th>
                          <th>Estado</th>
                        </tr>
                      </thead>
                      <tbody id="rl-anticipos-items">
                        <!-- Se llena din√°micamente -->
                      </tbody>
                      <tfoot>
                        <tr class="sl-total">
                          <td colspan="3">Total Anticipos</td>
                          <td class="r" id="rl-anticipos-total">$ 0,00</td>
                          <td></td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </section>
              </div>

              <footer class="sl-foot">
                <span>Generado por: <strong id="rl-user">{{ session['username'] }}</strong></span>
                <span>√öltima actualizaci√≥n: <strong id="rl-updated-at">‚Äî</strong></span>
              </footer>
            </section>

            {% if session.get('role_level', 1) == 2 %}
            <div class="sl-danger-wrap" style="margin-top:14px; display:flex; justify-content:flex-end;">
              <button id="rl-cerrar-local" class="btn btn-ghost" title="Cerrar el Local del d√≠a">üîí Cerrar Local</button>
            </div>
            {% endif %}
          </section>

          <!-- Derecha: documentos -->
          <aside>
            <section class="doc-card" aria-labelledby="doc-title">
              <div class="doc-head">
                <div style="display:flex; align-items:center; gap:10px;">
                  <span id="doc-title">Documentos</span>
                  <small class="muted">Im√°genes cargadas para auditor√≠a</small>
                </div>
                <div class="doc-actions">
                  <!-- √öNICO bot√≥n global -->
                  <button class="pill pill--primary" id="dl-all" title="Descargar todas las im√°genes">
                    <span class="ico" aria-hidden="true"></span>
                    <span>Todo</span>
                  </button>
                </div>
              </div>
              <div class="doc-body" id="doc-accordions"><!-- JS inyecta acordeones --></div>
            </section>
          </aside>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal visor -->
  <div class="modal" id="imgModal" role="dialog" aria-modal="true" aria-label="Visor de imagen">
    <div class="box">
      <div class="modal-actions">
        <button class="icon-btn" id="imgDownload" title="Descargar">
          <!-- SVG lo inyecta JS -->
        </button>
      </div>
      <button class="close" id="imgClose">Cerrar ‚úï</button>
      <img id="imgBig" alt="Imagen">
      <div class="caption" id="imgCaption"></div>
    </div>
  </div>

  <script>
    window.ROLE_LEVEL = {{ session.get('role_level', 1) | int }};
    window.SESSION_LOCAL = "{{ session.get('local') }}";
  </script>

  <!-- JS propio de esta vista (para im√°genes y filtros de auditor) -->
  <script>
  /* ====== ICONOS SVG (consistentes) ====== */
  const ICONS = {
    download: `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
           stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
           aria-hidden="true">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <path d="M7 10l5 5 5-5"/>
        <path d="M12 15V3"/>
      </svg>`,
    search: `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
           stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
           aria-hidden="true">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>`
  };

  // Helpers m√≠nimos
  function el(tag, attrs={}, ...children){
    const n = document.createElement(tag);
    Object.entries(attrs).forEach(([k,v])=>{
      if (k==='class') n.className=v;
      else if (k.startsWith('on') && typeof v==='function') n.addEventListener(k.slice(2), v);
      else n.setAttribute(k,v);
    });
    children.forEach(c=> n.appendChild(typeof c==='string' ? document.createTextNode(c) : c));
    return n;
  }

  async function loadLocalesIfNeeded(){
    const sel = document.getElementById('rl-local-select');
    if (!sel) return;

    // Intentar recuperar local guardado en localStorage
    const localGuardado = localStorage.getItem('rl_local_selected');

    sel.innerHTML = '<option value="">Seleccione un local</option>';

    try {
      const res = await fetch('/api/locales_options', {credentials:'same-origin'});
      const data = await res.json();
      const locales = (data && data.locales) || [];

      console.log('üîç Locales recibidos del servidor:', locales);
      console.log('üîç Local guardado en localStorage:', localGuardado);
      console.log('üîç SESSION_LOCAL:', window.SESSION_LOCAL);

      // Si no hay locales y tenemos SESSION_LOCAL, usarlo como fallback
      if (locales.length === 0 && window.SESSION_LOCAL) {
        locales.push(window.SESSION_LOCAL);
      }

      locales.forEach(l=>{
        if (!l) return; // Saltar valores null/undefined/vac√≠os
        const opt = el('option', {value:l}, l);
        // Prioridad: 1) localStorage, 2) SESSION_LOCAL
        if (localGuardado && l === localGuardado) {
          opt.selected = true;
        } else if (!localGuardado && l === window.SESSION_LOCAL) {
          opt.selected = true;
        }
        sel.appendChild(opt);
      });

      // Si hay un valor seleccionado, actualizar display
      if (sel.value && sel.value !== '') {
        document.getElementById('rl-local-display').textContent = sel.value;
      } else {
        document.getElementById('rl-local-display').textContent = 'Seleccione un local';
      }

      console.log('üîç Local seleccionado final:', sel.value);
    } catch (err) {
      console.error('‚ùå Error cargando locales:', err);
      // Fallback: si hay SESSION_LOCAL, agregarlo
      if (window.SESSION_LOCAL) {
        const opt = el('option', {value: window.SESSION_LOCAL}, window.SESSION_LOCAL);
        opt.selected = true;
        sel.appendChild(opt);
        document.getElementById('rl-local-display').textContent = window.SESSION_LOCAL;
      }
    }
  }

  /* ===== Render de Documentos con DESCARGAS ===== */
  let _lastGroups = [];
  let _modalCurrentItem = null;

  function iconBtn(onclick, title="Descargar", type='download') {
    const b = document.createElement('button');
    b.className = 'icon-btn';
    b.type = 'button';
    b.title = title;
    b.innerHTML = ICONS[type] || ICONS.download;
    if (onclick) b.addEventListener('click', e => { e.stopPropagation(); onclick(e); });
    return b;
  }

  function ensureGlobalDlIcon() {
    const all = document.getElementById('dl-all');
    if (!all) return;
    const ico = all.querySelector('.ico');
    if (ico && !ico.firstChild) {
      ico.innerHTML = ICONS.download;
    }
  }

  function renderDocs(groups){
    _lastGroups = groups || [];
    ensureGlobalDlIcon();

    const host = document.getElementById('doc-accordions');
    host.innerHTML = '';
    const order = [
      ['remesas','Remesas'],
      ['ventas_z','Ventas Z'],
      ['facturas','Facturas'],
      ['mercadopago','Mercado Pago'],
      ['tarjeta','Tarjeta'],
      ['rappi','Rappi'],
      ['pedidosya','PedidosYa'],
      ['gastos','Gastos'],
      ['cuenta_cte','Cuenta Cte.'],
      ['anticipos','Anticipos'],
    ];
    const byKey = {}; (groups||[]).forEach(g=>byKey[g.key]=g);

    order.forEach(([key,label])=>{
      const g = byKey[key] || {key, label, count:0, items:[]};
      const acc = el('div', {'class':'doc-acc', 'aria-expanded':'false'});
      const hdrLeft = el('div', {'class':'row-left'},
        el('span', {}, g.label || label),
        el('span', {'class':'count'}, String(g.count||0))
      );
      const hdrRight = el('div', {'class':'doc-actions'}, iconBtn(() => downloadGroup(g.key), `Descargar ${g.label||label}`, 'download'));
      const hdr = el('div', {'class':'doc-row'}, hdrLeft, hdrRight);
      hdr.addEventListener('click', ()=>toggle(acc));

      const body = el('div', {'class':'acc-body'},
        g.count ? buildThumbs(g.items) : el('div', {'class':'muted', style:'padding:10px;'}, 'Sin im√°genes cargadas')
      );
      acc.appendChild(hdr); acc.appendChild(body); host.appendChild(acc);
    });

    function toggle(acc){ acc.setAttribute('aria-expanded', acc.getAttribute('aria-expanded')==='true'?'false':'true'); }

    function buildThumbs(items){
      const wrap = el('div', {'class':'thumbs'});
      (items||[]).forEach(it=>{
        const card = el('div', {'class':'thumb'});
        const top = el('div', {'class':'thumb-top'});

        const img = el('img', {src: it.view_path || it.view_url || '', alt: it.name || 'imagen', loading:'lazy', decoding:'async'});
        const fallback = el('div', {'class':'media-fallback'}, it.name || 'Archivo');
        img.onerror = ()=>{ img.style.display='none'; fallback.style.display='block'; };

        const actions = el('div', {'class':'thumb-actions'});
        actions.appendChild(iconBtn(()=>openModal(it), 'Ver', 'search'));
        actions.appendChild(iconBtn(()=>downloadSingle(it), 'Descargar', 'download'));

        top.appendChild(img);
        top.appendChild(actions);

        const meta = el('div', {'class':'meta'}, it.name || '‚Äî');

        card.addEventListener('click', ()=>openModal(it));
        card.appendChild(top);
        card.appendChild(meta);
        card.appendChild(fallback);
        wrap.appendChild(card);
      });
      return wrap;
    }
  }

  /* ===== Modal ===== */
  function openModal(it){
    _modalCurrentItem = it;
    const img = document.getElementById('imgBig');
    img.src = it.view_path || it.view_url || '';
    document.getElementById('imgCaption').textContent = it.name || '';
    document.getElementById('imgModal').classList.add('is-open');
    // Asegura SVG en bot√≥n del modal
    const b = document.getElementById('imgDownload');
    if (b && !b.firstChild) b.innerHTML = ICONS.download;
  }
  function closeModal(){
    document.getElementById('imgModal').classList.remove('is-open');
    document.getElementById('imgBig').src = '';
    _modalCurrentItem = null;
  }
  document.getElementById('imgClose').addEventListener('click', closeModal);
  document.getElementById('imgModal').addEventListener('click', e => { if (e.target.id==='imgModal') closeModal(); });
  document.getElementById('imgDownload').addEventListener('click', (e)=>{
    e.stopPropagation();
    if (_modalCurrentItem) downloadSingle(_modalCurrentItem);
  });

  /* ===== Descargas ===== */
  function triggerDownload(href, filename){
    const a = document.createElement('a');
    a.href = href;
    if (filename) a.download = filename;
    a.rel = 'noopener';
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>a.remove(), 30);
  }
  function downloadSingle(item){
    const name = item.name || 'archivo';
    const href = (item.view_path || item.view_url || '#');
    triggerDownload(href, name);
  }
  function downloadGroup(key){
    const g = (_lastGroups||[]).find(x => x.key === key);
    if (!g || !g.items || !g.items.length) return;
    let i = 0;
    const tick = () => {
      if (i >= g.items.length) return;
      downloadSingle(g.items[i++]);
      setTimeout(tick, 160);
    };
    tick();
  }
  async function downloadAll(event){
    // Prevenir cualquier comportamiento por defecto y propagaci√≥n
    if (event) {
      event.preventDefault();
      event.stopPropagation();
      event.stopImmediatePropagation();
    }

    // NUEVO: Descargar todas las im√°genes en un ZIP organizado por carpetas
    const fecha = document.getElementById('rl-fecha').value;
    const selLocal = document.getElementById('rl-local-select');
    // Si existe el select, SOLO usar su valor. Si no existe, usar SESSION_LOCAL
    const local = selLocal ? (selLocal.value || '').trim() : (window.SESSION_LOCAL || '').trim();
    if (!fecha || !local) {
      alert('Por favor seleccione fecha y local');
      return false;
    }

    // Verificar que hay im√°genes
    const all = [];
    (_lastGroups||[]).forEach(g => (g.items||[]).forEach(it => all.push(it)));
    if (!all.length) {
      alert('No hay im√°genes para descargar');
      return false;
    }

    // Mostrar indicador de carga
    const btn = document.getElementById('dl-all');
    const originalText = btn.textContent;
    btn.textContent = 'Descargando...';
    btn.disabled = true;

    try {
      // Construir URL del endpoint de descarga ZIP
      const url = new URL('/files/download_all_media', location.origin);
      url.searchParams.set('fecha', fecha);
      url.searchParams.set('local', local);

      console.log('[DEBUG] Descargando ZIP desde:', url.toString());

      // Descargar usando fetch para evitar navegaci√≥n
      const response = await fetch(url.toString(), {
        credentials: 'same-origin',
        cache: 'no-store'
      });

      console.log('[DEBUG] Response status:', response.status);
      console.log('[DEBUG] Response content-type:', response.headers.get('content-type'));

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({error: 'Error desconocido'}));
        throw new Error(errorData.error || `Error ${response.status}`);
      }

      // Verificar que sea un ZIP
      const contentType = response.headers.get('content-type');
      if (!contentType || !contentType.includes('zip')) {
        console.error('[DEBUG] Content-Type inesperado:', contentType);
        throw new Error(`Respuesta inesperada. Content-Type: ${contentType}. Puede que el endpoint no exista.`);
      }

      // Convertir a blob
      const blob = await response.blob();
      console.log('[DEBUG] Blob size:', blob.size, 'bytes');

      // Crear URL temporal y descargar
      const blobUrl = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = blobUrl;
      a.download = `${local.replace(/\s+/g, '_')}_${fecha}.zip`;
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();

      // Limpiar
      setTimeout(() => {
        URL.revokeObjectURL(blobUrl);
        a.remove();
      }, 100);

      console.log('[DEBUG] Descarga completada exitosamente');

    } catch (error) {
      console.error('Error descargando ZIP:', error);
      alert('Error al descargar: ' + error.message);
    } finally {
      // Restaurar bot√≥n
      btn.textContent = originalText;
      btn.disabled = false;
    }

    return false;
  }
  document.getElementById('dl-all').addEventListener('click', downloadAll, true);

  /* ===== Fetch media ===== */
  async function loadMedia(){
    const fecha = document.getElementById('rl-fecha').value;
    const selLocal = document.getElementById('rl-local-select');
    // Si existe el select, SOLO usar su valor. Si no existe, usar SESSION_LOCAL
    const local = selLocal ? (selLocal.value || '').trim() : (window.SESSION_LOCAL || '').trim();
    if (!fecha || !local) return;
    const url = new URL('/files/summary_media', location.origin);
    url.searchParams.set('fecha', fecha);
    url.searchParams.set('local', local);
    const r = await fetch(url.toString(), {credentials:'same-origin', cache:'no-store'});
    if (!r.ok){ renderDocs([]); return; }
    const data = await r.json();
    renderDocs(data.groups || []);
  }

  /* ===== Dispara actualizaci√≥n de ambos paneles ===== */
  async function refreshAll(){
    const selLocal = document.getElementById('rl-local-select');
    const selectedLocal = selLocal?.value || window.SESSION_LOCAL;

    // Solo actualizar el display si hay un valor v√°lido
    const display = document.getElementById('rl-local-display');
    if (display && selectedLocal) {
      display.textContent = selectedLocal;
    }

    document.getElementById('rl-actualizar')?.dispatchEvent(new Event('click'));
    await loadMedia();
    // Actualizar botones de auditor√≠a si es nivel 3
    if (window.ROLE_LEVEL >= 3 && window.actualizarBotonesAuditoria) {
      await window.actualizarBotonesAuditoria();
    }
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    // Fecha: intentar cargar desde localStorage, sino usar hoy
    const inFecha = document.getElementById('rl-fecha');
    const fechaGuardada = localStorage.getItem('rl_fecha_selected');
    if (fechaGuardada) {
      inFecha.value = fechaGuardada;
      console.log('üìÖ Fecha restaurada desde localStorage:', fechaGuardada);
    } else {
      // Si NO hay fecha guardada, establecer fecha de hoy Y guardarla en localStorage
      const d = new Date(); const p=n=>String(n).padStart(2,'0');
      const fechaHoy = `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;
      inFecha.value = fechaHoy;
      localStorage.setItem('rl_fecha_selected', fechaHoy);
      console.log('üìÖ Fecha inicial establecida a hoy y guardada:', fechaHoy);
    }

    // Cargar locales primero
    await loadLocalesIfNeeded();

    // Restaurar local guardado desde localStorage DESPU√âS de cargar la lista
    const sel = document.getElementById('rl-local-select');
    const localGuardado = localStorage.getItem('rl_local_selected');
    if (sel && localGuardado) {
      const opcionExiste = Array.from(sel.options).some(opt => opt.value === localGuardado);
      if (opcionExiste) {
        sel.value = localGuardado;
        // Tambi√©n actualizar el display
        const display = document.getElementById('rl-local-display');
        if (display) display.textContent = localGuardado;
        console.log('üè™ Local restaurado desde localStorage:', localGuardado);
      }
    }

    // NOTA: La carga autom√°tica de datos se maneja en resumen_local.js (DOMContentLoaded)
    // pero ahora el local ya est√° correctamente restaurado

    document.getElementById('rl-actualizar')?.addEventListener('click', async () => {
      // Usar refreshAll() para cargar TODO (resumen + im√°genes + estado)
      await refreshAll();
    });
    document.getElementById('rl-fecha')?.addEventListener('change', (e) => {
      // Guardar fecha en localStorage para persistencia
      localStorage.setItem('rl_fecha_selected', e.target.value);
      refreshAll();
    });
    // Usar la misma variable sel declarada arriba
    if (sel) sel.addEventListener('change', (e) => {
      const nuevoLocal = e.target.value;

      // Si es Encargado (nivel 2), recargar p√°gina para actualizar sesi√≥n
      if (window.ROLE_LEVEL === 2) {
        window.location.href = `{{ url_for('resumen_local') }}?local=${encodeURIComponent(nuevoLocal)}`;
      } else {
        // Auditor: solo guardar en localStorage y refrescar datos
        localStorage.setItem('rl_local_selected', nuevoLocal);
        refreshAll();
      }
    });

    // Definir funci√≥n de auditor√≠a globalmente (para que est√© disponible antes del if)
    if (window.ROLE_LEVEL >= 3) {
      window.actualizarBotonesAuditoria = async function() {
        const selLocal = document.getElementById('rl-local-select');
        // Si existe el select, SOLO usar su valor. Si no existe, usar SESSION_LOCAL
        const local = selLocal ? (selLocal.value || '').trim() : (window.SESSION_LOCAL || '').trim();
        const fecha = document.getElementById('rl-fecha')?.value;

        console.log('üîç Actualizando botones auditor√≠a:', { local, fecha });

        const btnAuditado = document.getElementById('rl-marcar-auditado');
        const btnCargaMasiva = document.getElementById('rl-carga-masiva');

        if (!local || !fecha) {
          console.log('‚ö†Ô∏è Falta local o fecha');
          // Deshabilitar bot√≥n de marcar como auditado si faltan datos
          if (btnAuditado) {
            btnAuditado.disabled = true;
            btnAuditado.style.display = 'inline-block';
            btnAuditado.title = 'Seleccione local y fecha';
          }
          if (btnCargaMasiva) {
            btnCargaMasiva.style.display = 'none';
          }
          return;
        }

        try {
          // Verificar si el local est√° cerrado
          const resEstado = await fetch(`/estado_local?local=${encodeURIComponent(local)}&fecha=${encodeURIComponent(fecha)}`);
          const dataEstado = await resEstado.json();
          const localCerrado = dataEstado.ok && dataEstado.estado === 0;
          console.log('üìä Estado local:', dataEstado, 'localCerrado:', localCerrado);

          // Verificar si est√° auditado
          const urlAudit = `/api/estado_auditoria?local=${encodeURIComponent(local)}&fecha=${encodeURIComponent(fecha)}`;
          console.log('üîó URL auditor√≠a:', urlAudit);

          const resAudit = await fetch(urlAudit);
          const dataAudit = await resAudit.json();
          const auditado = dataAudit.success && dataAudit.auditado;
          console.log('‚úÖ Estado auditor√≠a:', dataAudit, 'auditado:', auditado);

          // Mostrar botones seg√∫n estado
          console.log('üéØ Evaluando botones:', {
            localCerrado,
            auditado,
            existeBtnAuditado: !!btnAuditado,
            existeBtnCargaMasiva: !!btnCargaMasiva
          });

          // Bot√≥n "Marcar como Auditado": SIEMPRE VISIBLE
          if (btnAuditado) {
            btnAuditado.style.display = 'inline-block';

            if (auditado) {
              // Si ya est√° auditado, ocultar el bot√≥n (se mostrar√° Carga Masiva en su lugar)
              console.log('‚ùå Ocultando bot√≥n AUDITADO (ya est√° auditado)');
              btnAuditado.style.display = 'none';
            } else if (localCerrado) {
              // Si est√° cerrado pero no auditado, habilitar
              console.log('‚úÖ Habilitando bot√≥n AUDITADO (local cerrado)');
              btnAuditado.disabled = false;
              btnAuditado.title = 'Marcar local como auditado';
            } else {
              // Si no est√° cerrado, mostrar pero deshabilitar
              console.log('‚ö†Ô∏è Deshabilitando bot√≥n AUDITADO (local no cerrado)');
              btnAuditado.disabled = true;
              btnAuditado.title = 'El local debe estar cerrado para marcarlo como auditado';
            }
          }

          // Bot√≥n "Carga Masiva": Solo si est√° auditado
          if (btnCargaMasiva) {
            if (auditado) {
              console.log('‚úÖ Mostrando bot√≥n CARGA MASIVA');
              btnCargaMasiva.style.display = 'inline-block';
            } else {
              console.log('‚ùå Ocultando bot√≥n CARGA MASIVA (no auditado)');
              btnCargaMasiva.style.display = 'none';
            }
          }
        } catch (e) {
          console.error('‚ùå Error verificando estado de auditor√≠a:', e);
          // En caso de error, mostrar bot√≥n de auditado pero deshabilitado
          if (btnAuditado) {
            btnAuditado.style.display = 'inline-block';
            btnAuditado.disabled = true;
            btnAuditado.title = 'Error al verificar estado del local';
          }
          if (btnCargaMasiva) {
            btnCargaMasiva.style.display = 'none';
          }
        }
      };

      // Botones de auditor√≠a
      const btnAuditado = document.getElementById('rl-marcar-auditado');
      const btnCargaMasiva = document.getElementById('rl-carga-masiva');

      // Bot√≥n Marcar Auditado
      btnAuditado?.addEventListener('click', async () => {
        const selLocal = document.getElementById('rl-local-select');
        // Si existe el select, SOLO usar su valor. Si no existe, usar SESSION_LOCAL
        const local = selLocal ? (selLocal.value || '').trim() : (window.SESSION_LOCAL || '').trim();
        const fecha = document.getElementById('rl-fecha')?.value;

        // Verificar primero si el local est√° cerrado
        try {
          const resEstado = await fetch(`/estado_local?local=${encodeURIComponent(local)}&fecha=${encodeURIComponent(fecha)}`);
          const dataEstado = await resEstado.json();
          const localCerrado = dataEstado.ok && dataEstado.estado === 0;

          if (!localCerrado) {
            alert('‚ùå Error: El local debe estar CERRADO para poder marcarlo como auditado.');
            return;
          }
        } catch (e) {
          alert('‚ùå Error verificando estado del local: ' + e.message);
          return;
        }

        if (!confirm(`¬øConfirmar que el local "${local}" para la fecha ${fecha} est√° AUDITADO?\n\nDespu√©s de esto NO se podr√°n realizar m√°s cambios.`)) {
          return;
        }

        try {
          const res = await fetch('/api/marcar_auditado', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ local, fecha })
          });
          const data = await res.json();
          console.log('üîí Respuesta marcar_auditado:', data);

          if (data.success) {
            alert('‚úÖ Local marcado como AUDITADO');
            await window.actualizarBotonesAuditoria();
            await loadMedia(); // Refrescar datos
          } else {
            alert('‚ùå Error: ' + (data.msg || 'No se pudo marcar como auditado'));
          }
        } catch (e) {
          alert('‚ùå Error de red: ' + e.message);
        }
      });

      // Bot√≥n Carga Masiva
      btnCargaMasiva?.addEventListener('click', () => {
        const localSelect = document.getElementById('rl-local-select');
        const fechaInput = document.getElementById('rl-fecha');

        const local = localSelect?.value || window.SESSION_LOCAL;
        const fecha = fechaInput?.value;

        console.log('üîç Carga Masiva - Elementos:', {
          localSelect,
          fechaInput,
          'localSelect.value': localSelect?.value,
          'fechaInput.value': fechaInput?.value,
          'window.SESSION_LOCAL': window.SESSION_LOCAL,
          'local final': local,
          'fecha final': fecha
        });

        if (!local || !fecha) {
          alert(`‚ö†Ô∏è Error: Faltan par√°metros\nLocal: "${local}"\nFecha: "${fecha}"`);
          return;
        }

        // Redirigir a /auditoria con par√°metros
        const url = `/auditoria?local=${encodeURIComponent(local)}&fecha=${encodeURIComponent(fecha)}`;
        console.log('üîó Redirigiendo a:', url);
        window.location.href = url;
      });

      // Llamada inicial para actualizar el estado de los botones
      console.log('üîÑ Llamando a actualizarBotonesAuditoria() inicialmente');
      window.actualizarBotonesAuditoria();
    }
  });
  </script>

  <!-- Toggle del men√∫ m√≥vil -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const layout = document.querySelector('.layout');
    const sidebar = document.querySelector('.sidebar');

    if (mobileMenuBtn && layout) {
      mobileMenuBtn.addEventListener('click', () => {
        layout.classList.toggle('sidebar-open');
      });

      // Cerrar sidebar al hacer click en un enlace (solo en mobile)
      if (sidebar && window.innerWidth <= 768) {
        sidebar.querySelectorAll('a.nav-item').forEach(link => {
          link.addEventListener('click', () => {
            setTimeout(() => {
              layout.classList.remove('sidebar-open');
            }, 200);
          });
        });
      }

      // Cerrar sidebar al hacer click fuera de ella
      document.addEventListener('click', (e) => {
        if (window.innerWidth <= 768 &&
            layout.classList.contains('sidebar-open') &&
            !sidebar.contains(e.target) &&
            !mobileMenuBtn.contains(e.target)) {
          layout.classList.remove('sidebar-open');
        }
      });
    }
  });
  </script>

  <!-- Tu JS existente para rellenar el RESUMEN NUM√âRICO -->
  <script src="{{ url_for('static', filename='js/resumen_local.js') }}"></script>
</body>
</html>
