<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Resumen Local - Sistema de Gesti√≥n de Flujo de Cajas</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/resumen_local.css') }}">

  <style>
    /* Gris fuerte en encabezados */
    .sl-section > .sl-title,
    .doc-card > .doc-head { background:#5f6672 !important; color:#fff !important; }
    .acc[aria-expanded="true"] > .sl-title { background:#5f6672 !important; color:#fff !important; }

    .grid-2col { display:grid; grid-template-columns: 1fr 380px; gap:20px; }
    .doc-card { border-radius:12px; overflow:hidden; box-shadow: 0 2px 10px rgba(0,0,0,.06); background:#fff; }
    .doc-head { padding:12px 16px; font-weight:700; display:flex; align-items:center; justify-content:space-between; }
    .doc-body { padding:12px; }

    .doc-actions { display:flex; gap:8px; align-items:center; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px; cursor:pointer; border:1px solid #cbd5e1; background:#fff; color:#334155; font-weight:700; }
    .pill--primary { border-color:#2563eb; background:#2563eb; color:#fff; }
    .icon-btn { display:inline-flex; align-items:center; justify-content:center; width:32px; height:32px; border:1px solid #cbd5e1; border-radius:8px; background:#fff; cursor:pointer; }
    .icon-btn svg, .pill .ico svg { width:16px; height:16px; display:block; }

    .doc-acc { border-bottom:1px solid #e5e7eb; }
    .doc-row { padding:10px 12px; display:flex; align-items:center; justify-content:space-between; cursor:pointer; }
    .doc-row:hover { background:#f5f6f8; }
    .doc-row .row-left { display:flex; align-items:center; gap:8px; }
    .doc-row .count { font-weight:700; padding:2px 8px; border-radius:999px; background:#eef2f7; color:#334155; }
    .doc-acc .acc-body { display:none; background:#f5f6f8; }
    .doc-acc[aria-expanded="true"] .acc-body { display:block; }

    .thumbs { display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:10px; }
    .thumb { background:#fff; border-radius:8px; overflow:hidden; border:1px solid #e5e7eb; cursor:pointer; }
    .thumb .thumb-top { position:relative; }
    .thumb img { width:100%; height:140px; object-fit:cover; display:block; }
    .thumb .thumb-actions { position:absolute; right:6px; top:6px; display:flex; gap:6px; }
    .thumb .thumb-actions .icon-btn { padding:4px 6px; font-size:12px; }
    .thumb .meta { padding:6px 8px; font-size:.85rem; color:#374151; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .media-fallback { display:none; padding:6px 8px; font-size:.85rem; background:#f1f5f9; border-top:1px solid #e5e7eb; }

    .modal { position:fixed; inset:0; background:rgba(15,23,42,.7); display:none; align-items:center; justify-content:center; z-index:9999; }
    .modal.is-open { display:flex; }
    .modal .box { background:#0b1220; max-width:min(96vw,1100px); max-height:90vh; padding:10px; border-radius:12px; position:relative; }
    .modal img { max-width:100%; max-height:82vh; display:block; margin:0 auto; }
    .modal .close { position:absolute; top:8px; right:8px; background:#111827; color:#fff; border:1px solid #374151; border-radius:8px; padding:6px 10px; cursor:pointer; }
    .modal .caption { color:#d1d5db; padding-top:8px; font-size:.9rem; text-align:center; }
    .modal .modal-actions { position:absolute; left:8px; top:8px; display:flex; gap:8px; }

    .filters { display:flex; gap:12px; align-items:flex-end; }
    .filters .form-group { display:flex; flex-direction:column; gap:4px; }
    .filters .grow { flex:1; }
    .btn { border-radius:10px; padding:10px 14px; border:1px solid #2563eb; background:#2563eb; color:#fff; font-weight:700; }
    .btn-ghost { border:1px solid #cbd5e1; background:#fff; color:#334155; }
    .muted { opacity:.7; }
    .negative-amount { color:#b91c1c; font-weight:700; }
  </style>
</head>
<body>
  <div id="app" class="ui-scale layout">
    <!-- Sidebar -->
    <aside class="sidebar" role="navigation" aria-label="Barra lateral">
      <div class="sidebar__brand">
        <div class="brand-mark" aria-hidden="true">NG</div>
        <div class="brand-meta"><strong>Sistema</strong><span>Gesti√≥n de Flujo de Cajas</span></div>
      </div>

      <nav class="sidebar__nav">
        <a class="nav-item is-active" href="{{ url_for('resumen_local') }}"><span class="nav-dot"></span>Resumen Local</a>
        <a class="nav-item" href="{{ url_for('index') }}"><span class="nav-dot"></span>Carga de Datos</a>
        <div class="nav-group">
          <a href="javascript:void(0)" id="navReportes" class="nav-item nav-toggle">
            <span class="nav-dot"></span>Reporter√≠a
            <svg class="nav-caret" width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" fill="none"><polyline points="6 9 12 15 18 9"/></svg>
          </a>
          <div class="nav-sub">
            <a class="nav-item nav-sub-item" href="{{ url_for('ui_reporteria_remesas') }}"><span class="nav-dot"></span>Remesas</a>
          </div>
        </div>
      </nav>

      <div class="sidebar__footer"><a class="nav-ghost" href="{{ url_for('logout') }}">Cerrar Sesi√≥n</a></div>
      <button class="sidebar__toggle" id="toggleSidebar" aria-label="Abrir/cerrar men√∫">‚ò∞</button>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="container">
        <!-- Filtros -->
        <div class="filters" style="margin-bottom:16px;">
          <div class="form-group">
            <label for="rl-fecha">Fecha</label>
            <input type="date" id="rl-fecha">
          </div>

          {% if session.get('role_level',1) | int >= 3 %}
          <div class="form-group grow">
            <label for="rl-local-select">Local</label>
            <select id="rl-local-select"></select>
          </div>
          {% else %}
          <div class="form-group grow">
            <label>Local</label>
            <input id="rl-local-inline" type="text" value="{{ session['local'] }}" readonly>
          </div>
          {% endif %}

          <div class="form-group"><button id="rl-actualizar" class="btn">Actualizar</button></div>
          <div class="form-group"><button id="rl-imprimir" class="btn btn-ghost">Imprimir</button></div>

          {% if session.get('role_level',1) | int >= 3 %}
          <div class="form-group">
            <button id="rl-marcar-auditado" class="btn" style="display:none; background-color:#ff9800;">üîí Marcar Auditado</button>
          </div>
          <div class="form-group">
            <button id="rl-carga-masiva" class="btn" style="display:none; background-color:#4caf50;">üìã Carga Masiva</button>
          </div>
          {% endif %}
        </div>

        <!-- 2 columnas -->
        <div class="grid-2col">
          <!-- Izquierda: acordeones num√©ricos -->
          <section>
            <section class="sl-panel" aria-labelledby="sl-title">
              <header class="sl-head">
                <h1 id="sl-title">Cierre Global del D√≠a
                  <span id="rl-badge-estado" class="sl-badge" style="display:none;"></span>
                </h1>
                <div class="sl-meta">
                  <div><strong>Fecha:</strong> <span id="rl-fecha-display">‚Äî</span></div>
                  <div><strong>Hora:</strong> <span id="rl-hora-display">‚Äî</span></div>
                  <div><strong>Local:</strong> <span id="rl-local-display">{{ session['local'] }}</span></div>
                </div>
              </header>

              <div class="sl-body">
                <!-- RESUMEN -->
                <section class="sl-section acc" aria-expanded="true">
                  <div class="sl-title">Resumen</div>
                  <div class="acc-body">
                    <table class="sl-table">
                      <tr><td>Venta Total</td><td class="r" id="rl-venta-total">0,00</td></tr>
                      <tr><td>Total Cobrado</td><td class="r" id="rl-total-cobrado">0,00</td></tr>
                      <tr class="sl-total"><td>Diferencia</td><td class="r" id="rl-diferencia">0,00</td></tr>
                    </table>
                  </div>
                </section>

                <!-- FACTURAS -->
                <section class="sl-section acc" aria-expanded="true">
                  <div class="sl-title">Facturas</div>
                  <div class="acc-body">
                    <!-- Ventas Z -->
                    <div class="sub-acc acc" aria-expanded="false">
                      <div class="sl-row"><span class="label">Ventas Z</span><span class="amount r" id="rl-vz-total">0,00</span></div>
                      <div class="acc-body">
                        <table class="sl-table">
                          <thead><tr><th>Z (PV-N√∫mero)</th><th class="r">Monto</th></tr></thead>
                          <tbody id="rl-vz-items"><tr class="muted"><td colspan="2">Sin ventas z cargadas</td></tr></tbody>
                          <tfoot><tr class="sl-total"><td>Total</td><td class="r" id="rl-vz-total-foot">0,00</td></tr></tfoot>
                        </table>
                      </div>
                    </div>

                    <!-- Facturas A -->
                    <div class="sub-acc acc" aria-expanded="false">
                      <div class="sl-row"><span class="label">Facturas A</span><span class="amount r" id="rl-fa-total">0,00</span></div>
                      <div class="acc-body">
                        <table class="sl-table">
                          <thead><tr><th>Factura A (PV-N√∫mero)</th><th class="r">Monto</th></tr></thead>
                          <tbody id="rl-fa-items"><tr class="muted"><td colspan="2">Sin facturas A cargadas</td></tr></tbody>
                          <tfoot><tr class="sl-total"><td>Total</td><td class="r" id="rl-fa-total-foot">0,00</td></tr></tfoot>
                        </table>
                      </div>
                    </div>

                    <!-- Facturas B -->
                    <div class="sub-acc acc" aria-expanded="false">
                      <div class="sl-row"><span class="label">Facturas B</span><span class="amount r" id="rl-fb-total">0,00</span></div>
                      <div class="acc-body">
                        <table class="sl-table">
                          <thead><tr><th>Factura B (PV-N√∫mero)</th><th class="r">Monto</th></tr></thead>
                          <tbody id="rl-fb-items"><tr class="muted"><td colspan="2">Sin facturas B cargadas</td></tr></tbody>
                          <tfoot><tr class="sl-total"><td>Total</td><td class="r" id="rl-fb-total-foot">0,00</td></tr></tfoot>
                        </table>
                      </div>
                    </div>

                    <table class="sl-table">
                      <tr><td>Discovery</td><td class="r" id="rl-discovery">0,00</td></tr>
                    </table>
                  </div>
                </section>

                <!-- VENTAS POR MEDIO (COMPLETO) -->
                <section class="sl-section acc" aria-expanded="true">
                  <div class="sl-title">Ventas por medio</div>
                  <div class="acc-body">

                    <!-- Efectivo -->
                    <div class="sub-acc acc" aria-expanded="false">
                      <div class="sl-row"><span class="label">Efectivo</span><span class="amount r" id="rl-cash">0,00</span></div>
                      <div class="acc-body">
                        <table class="sl-table">
                          <tr><td>Remesas</td><td class="r" id="rl-remesas">0,00</td></tr>
                          <tr><td>Neto efectivo</td><td class="r" id="rl-cash-neto">0,00</td></tr>
                        </table>

                        <!-- Remesas retiradas -->
                        <div class="sub-acc acc" aria-expanded="false">
                          <div class="sl-row">
                            <span class="label">Remesas retiradas</span>
                            <span class="amount r"><span id="rl-remesas-ret-total">0,00</span> <span class="muted">(<span id="rl-remesas-ret-count">0</span>)</span></span>
                          </div>
                          <div class="acc-body">
                            <table class="sl-table">
                              <thead><tr><th>#</th><th>Fecha</th><th class="r">Monto</th></tr></thead>
                              <tbody id="rl-remesas-ret-items"><tr class="muted"><td colspan="3">Sin datos‚Ä¶</td></tr></tbody>
                            </table>
                          </div>
                        </div>

                        <!-- Remesas no retiradas -->
                        <div class="sub-acc acc" aria-expanded="false">
                          <div class="sl-row">
                            <span class="label">Remesas no retiradas</span>
                            <span class="amount r"><span id="rl-remesas-no-ret-total">0,00</span> <span class="muted">(<span id="rl-remesas-no-ret-count">0</span>)</span></span>
                          </div>
                          <div class="acc-body">
                            <table class="sl-table">
                              <thead><tr><th>#</th><th>Fecha</th><th class="r">Monto</th></tr></thead>
                              <tbody id="rl-remesas-no-ret-items"><tr class="muted"><td colspan="3">Sin datos‚Ä¶</td></tr></tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Mercado Pago -->
                    <div class="sub-acc acc" aria-expanded="false">
                      <div class="sl-row"><span class="label">Mercado Pago</span><span class="amount r" id="rl-mp">0,00</span></div>
                      <div class="acc-body">
                        <table class="sl-table">
                          <tr><td>Tips Mercado Pago</td><td class="r" id="rl-mp-tips">0,00</td></tr>
                        </table>
                      </div>
                    </div>

                    <!-- Tarjeta -->
                    <div class="sub-acc acc" aria-expanded="false">
                      <div class="sl-row"><span class="label">Tarjeta</span><span class="amount r" id="rl-card">0,00</span></div>
                      <div class="acc-body">
                        <table class="sl-table">
                          <tr><td>VISA</td><td class="r" id="rl-tj-visa">0,00</td></tr>
                          <tr><td>VISA D√âBITO</td><td class="r" id="rl-tj-visa-deb">0,00</td></tr>
                          <tr><td>VISA PREPAGO</td><td class="r" id="rl-tj-visa-pre">0,00</td></tr>
                          <tr><td>MASTERCARD</td><td class="r" id="rl-tj-mc">0,00</td></tr>
                          <tr><td>MASTERCARD D√âBITO</td><td class="r" id="rl-tj-mc-deb">0,00</td></tr>
                          <tr><td>MASTERCARD PREPAGO</td><td class="r" id="rl-tj-mc-pre">0,00</td></tr>
                          <tr><td>CABAL</td><td class="r" id="rl-tj-cabal">0,00</td></tr>
                          <tr><td>CABAL D√âBITO</td><td class="r" id="rl-tj-cabal-deb">0,00</td></tr>
                          <tr><td>AMEX</td><td class="r" id="rl-tj-amex">0,00</td></tr>
                          <tr><td>MAESTRO</td><td class="r" id="rl-tj-maestro">0,00</td></tr>
                          <tr><td>NARANJA</td><td class="r" id="rl-tj-naranja">0,00</td></tr>
                          <tr><td>DECIDIR</td><td class="r" id="rl-tj-decidir">0,00</td></tr>
                          <tr><td>DINERS</td><td class="r" id="rl-tj-diners">0,00</td></tr>
                          <tr><td>PAGOS INMEDIATOS</td><td class="r" id="rl-tj-pagos-inm">0,00</td></tr>
                          <tr class="sl-total"><td>Total tarjetas</td><td class="r" id="rl-card-total">0,00</td></tr>
                        </table>
                      </div>
                    </div>

                    <!-- Rappi -->
                    <div class="sub-acc acc" aria-expanded="false">
                      <div class="sl-row"><span class="label">Rappi</span><span class="amount r" id="rl-rappi">0,00</span></div>
                      <div class="acc-body">
                        <table class="sl-table">
                          <tr><td>Total Rappi</td><td class="r" id="rl-rappi-det">0,00</td></tr>
                        </table>
                      </div>
                    </div>

                    <!-- PedidosYa -->
                    <div class="sub-acc acc" aria-expanded="false">
                      <div class="sl-row"><span class="label">PedidosYa</span><span class="amount r" id="rl-pedidosya">0,00</span></div>
                      <div class="acc-body">
                        <table class="sl-table">
                          <tr><td>Total PedidosYa</td><td class="r" id="rl-pedidosya-det">0,00</td></tr>
                        </table>
                      </div>
                    </div>

                    <!-- Gastos -->
                    <div class="sub-acc acc" aria-expanded="false">
                      <div class="sl-row"><span class="label">Gastos</span><span class="amount r" id="rl-gastos">0,00</span></div>
                      <div class="acc-body">
                        <table class="sl-table">
                          <tr><td>Caja chica</td><td class="r" id="rl-g-caja">0,00</td></tr>
                          <tr><td>Otros</td><td class="r" id="rl-g-otros">0,00</td></tr>
                          <tr class="sl-total"><td>Total gastos</td><td class="r" id="rl-g-total">0,00</td></tr>
                        </table>
                      </div>
                    </div>

                    <!-- Cuenta Cte. -->
                    <div class="sub-acc acc" aria-expanded="false">
                      <div class="sl-row"><span class="label">Cuenta Cte.</span><span class="amount r" id="rl-cta-cte">0,00</span></div>
                      <div class="acc-body">
                        <table class="sl-table">
                          <tr><td>Facturas CC</td><td class="r" id="rl-cta-cte-cc">0,00</td></tr>
                        </table>
                      </div>
                    </div>

                    <!-- TIPs -->
                    <div class="sub-acc acc" aria-expanded="false">
                      <div class="sl-row"><span class="label">TIPs</span><span class="amount r" id="rl-tips">0,00</span></div>
                      <div class="acc-body">
                        <table class="sl-table">
                          <tr><td>Total propinas</td><td class="r" id="rl-tips-det">0,00</td></tr>
                          <tr><td>Mercado Pago</td><td class="r" id="rl-tips-mp">0,00</td></tr>
                          <tr><td>VISA</td><td class="r" id="rl-tip-visa">0,00</td></tr>
                          <tr><td>VISA D√âBITO</td><td class="r" id="rl-tip-visa-deb">0,00</td></tr>
                          <tr><td>VISA PREPAGO</td><td class="r" id="rl-tip-visa-pre">0,00</td></tr>
                          <tr><td>MASTERCARD</td><td class="r" id="rl-tip-mc">0,00</td></tr>
                          <tr><td>MASTERCARD D√âBITO</td><td class="r" id="rl-tip-mc-deb">0,00</td></tr>
                          <tr><td>MASTERCARD PREPAGO</td><td class="r" id="rl-tip-mc-pre">0,00</td></tr>
                          <tr><td>CABAL</td><td class="r" id="rl-tip-cabal">0,00</td></tr>
                          <tr><td>CABAL D√âBITO</td><td class="r" id="rl-tip-cabal-deb">0,00</td></tr>
                          <tr><td>AMEX</td><td class="r" id="rl-tip-amex">0,00</td></tr>
                          <tr><td>MAESTRO</td><td class="r" id="rl-tip-maestro">0,00</td></tr>
                          <tr><td>NARANJA</td><td class="r" id="rl-tip-naranja">0,00</td></tr>
                          <tr><td>DECIDIR</td><td class="r" id="rl-tip-decidir">0,00</td></tr>
                          <tr><td>DINERS</td><td class="r" id="rl-tip-diners">0,00</td></tr>
                          <tr><td>PAGOS INMEDIATOS</td><td class="r" id="rl-tip-pagos-inm">0,00</td></tr>
                          <tr class="sl-total"><td>Propinas Tarjetas</td><td class="r" id="rl-tips-tarjetas">0,00</td></tr>
                        </table>
                      </div>
                    </div>

                  </div>
                </section>
              </div>

              <footer class="sl-foot">
                <span>Generado por: <strong id="rl-user">{{ session['username'] }}</strong></span>
                <span>√öltima actualizaci√≥n: <strong id="rl-updated-at">‚Äî</strong></span>
              </footer>
            </section>

            {% if session.get('role_level', 1) == 2 %}
            <div class="sl-danger-wrap" style="margin-top:14px; display:flex; justify-content:flex-end;">
              <button id="rl-cerrar-local" class="btn btn-ghost" title="Cerrar el Local del d√≠a">üîí Cerrar Local</button>
            </div>
            {% endif %}
          </section>

          <!-- Derecha: documentos -->
          <aside>
            <section class="doc-card" aria-labelledby="doc-title">
              <div class="doc-head">
                <div style="display:flex; align-items:center; gap:10px;">
                  <span id="doc-title">Documentos</span>
                  <small class="muted">Im√°genes cargadas para auditor√≠a</small>
                </div>
                <div class="doc-actions">
                  <!-- √öNICO bot√≥n global -->
                  <button class="pill pill--primary" id="dl-all" title="Descargar todas las im√°genes">
                    <span class="ico" aria-hidden="true"></span>
                    <span>Todo</span>
                  </button>
                </div>
              </div>
              <div class="doc-body" id="doc-accordions"><!-- JS inyecta acordeones --></div>
            </section>
          </aside>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal visor -->
  <div class="modal" id="imgModal" role="dialog" aria-modal="true" aria-label="Visor de imagen">
    <div class="box">
      <div class="modal-actions">
        <button class="icon-btn" id="imgDownload" title="Descargar">
          <!-- SVG lo inyecta JS -->
        </button>
      </div>
      <button class="close" id="imgClose">Cerrar ‚úï</button>
      <img id="imgBig" alt="Imagen">
      <div class="caption" id="imgCaption"></div>
    </div>
  </div>

  <script>
    window.ROLE_LEVEL = {{ session.get('role_level', 1) | int }};
    window.SESSION_LOCAL = "{{ session.get('local') }}";
  </script>

  <!-- JS propio de esta vista (para im√°genes y filtros de auditor) -->
  <script>
  /* ====== ICONOS SVG (consistentes) ====== */
  const ICONS = {
    download: `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
           stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
           aria-hidden="true">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <path d="M7 10l5 5 5-5"/>
        <path d="M12 15V3"/>
      </svg>`,
    search: `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
           stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
           aria-hidden="true">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>`
  };

  // Helpers m√≠nimos
  function el(tag, attrs={}, ...children){
    const n = document.createElement(tag);
    Object.entries(attrs).forEach(([k,v])=>{
      if (k==='class') n.className=v;
      else if (k.startsWith('on') && typeof v==='function') n.addEventListener(k.slice(2), v);
      else n.setAttribute(k,v);
    });
    children.forEach(c=> n.appendChild(typeof c==='string' ? document.createTextNode(c) : c));
    return n;
  }

  async function loadLocalesIfNeeded(){
    const sel = document.getElementById('rl-local-select');
    if (!sel) return;
    sel.innerHTML = '<option>Cargando‚Ä¶</option>';
    const res = await fetch('/api/locales_options', {credentials:'same-origin'});
    const data = await res.json();
    const locales = (data && data.locales) || [window.SESSION_LOCAL];
    sel.innerHTML='';
    locales.forEach(l=>{
      const opt = el('option', {value:l}, l);
      if (l === window.SESSION_LOCAL) opt.selected = true;
      sel.appendChild(opt);
    });
    document.getElementById('rl-local-display').textContent = sel.value || window.SESSION_LOCAL;
  }

  /* ===== Render de Documentos con DESCARGAS ===== */
  let _lastGroups = [];
  let _modalCurrentItem = null;

  function iconBtn(onclick, title="Descargar", type='download') {
    const b = document.createElement('button');
    b.className = 'icon-btn';
    b.type = 'button';
    b.title = title;
    b.innerHTML = ICONS[type] || ICONS.download;
    if (onclick) b.addEventListener('click', e => { e.stopPropagation(); onclick(e); });
    return b;
  }

  function ensureGlobalDlIcon() {
    const all = document.getElementById('dl-all');
    if (!all) return;
    const ico = all.querySelector('.ico');
    if (ico && !ico.firstChild) {
      ico.innerHTML = ICONS.download;
    }
  }

  function renderDocs(groups){
    _lastGroups = groups || [];
    ensureGlobalDlIcon();

    const host = document.getElementById('doc-accordions');
    host.innerHTML = '';
    const order = [
      ['remesas','Remesas'],
      ['ventas_z','Ventas Z'],
      ['facturas','Facturas'],
      ['mercadopago','Mercado Pago'],
      ['tarjeta','Tarjeta'],
      ['rappi','Rappi'],
      ['pedidosya','PedidosYa'],
      ['gastos','Gastos'],
      ['cuenta_cte','Cuenta Cte.'],
    ];
    const byKey = {}; (groups||[]).forEach(g=>byKey[g.key]=g);

    order.forEach(([key,label])=>{
      const g = byKey[key] || {key, label, count:0, items:[]};
      const acc = el('div', {'class':'doc-acc', 'aria-expanded':'false'});
      const hdrLeft = el('div', {'class':'row-left'},
        el('span', {}, g.label || label),
        el('span', {'class':'count'}, String(g.count||0))
      );
      const hdrRight = el('div', {'class':'doc-actions'}, iconBtn(() => downloadGroup(g.key), `Descargar ${g.label||label}`, 'download'));
      const hdr = el('div', {'class':'doc-row'}, hdrLeft, hdrRight);
      hdr.addEventListener('click', ()=>toggle(acc));

      const body = el('div', {'class':'acc-body'},
        g.count ? buildThumbs(g.items) : el('div', {'class':'muted', style:'padding:10px;'}, 'Sin im√°genes cargadas')
      );
      acc.appendChild(hdr); acc.appendChild(body); host.appendChild(acc);
    });

    function toggle(acc){ acc.setAttribute('aria-expanded', acc.getAttribute('aria-expanded')==='true'?'false':'true'); }

    function buildThumbs(items){
      const wrap = el('div', {'class':'thumbs'});
      (items||[]).forEach(it=>{
        const card = el('div', {'class':'thumb'});
        const top = el('div', {'class':'thumb-top'});

        const img = el('img', {src: it.view_path || it.view_url || '', alt: it.name || 'imagen', loading:'lazy', decoding:'async'});
        const fallback = el('div', {'class':'media-fallback'}, it.name || 'Archivo');
        img.onerror = ()=>{ img.style.display='none'; fallback.style.display='block'; };

        const actions = el('div', {'class':'thumb-actions'});
        actions.appendChild(iconBtn(()=>openModal(it), 'Ver', 'search'));
        actions.appendChild(iconBtn(()=>downloadSingle(it), 'Descargar', 'download'));

        top.appendChild(img);
        top.appendChild(actions);

        const meta = el('div', {'class':'meta'}, it.name || '‚Äî');

        card.addEventListener('click', ()=>openModal(it));
        card.appendChild(top);
        card.appendChild(meta);
        card.appendChild(fallback);
        wrap.appendChild(card);
      });
      return wrap;
    }
  }

  /* ===== Modal ===== */
  function openModal(it){
    _modalCurrentItem = it;
    const img = document.getElementById('imgBig');
    img.src = it.view_path || it.view_url || '';
    document.getElementById('imgCaption').textContent = it.name || '';
    document.getElementById('imgModal').classList.add('is-open');
    // Asegura SVG en bot√≥n del modal
    const b = document.getElementById('imgDownload');
    if (b && !b.firstChild) b.innerHTML = ICONS.download;
  }
  function closeModal(){
    document.getElementById('imgModal').classList.remove('is-open');
    document.getElementById('imgBig').src = '';
    _modalCurrentItem = null;
  }
  document.getElementById('imgClose').addEventListener('click', closeModal);
  document.getElementById('imgModal').addEventListener('click', e => { if (e.target.id==='imgModal') closeModal(); });
  document.getElementById('imgDownload').addEventListener('click', (e)=>{
    e.stopPropagation();
    if (_modalCurrentItem) downloadSingle(_modalCurrentItem);
  });

  /* ===== Descargas ===== */
  function triggerDownload(href, filename){
    const a = document.createElement('a');
    a.href = href;
    if (filename) a.download = filename;
    a.rel = 'noopener';
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>a.remove(), 30);
  }
  function downloadSingle(item){
    const name = item.name || 'archivo';
    const href = (item.view_path || item.view_url || '#');
    triggerDownload(href, name);
  }
  function downloadGroup(key){
    const g = (_lastGroups||[]).find(x => x.key === key);
    if (!g || !g.items || !g.items.length) return;
    let i = 0;
    const tick = () => {
      if (i >= g.items.length) return;
      downloadSingle(g.items[i++]);
      setTimeout(tick, 160);
    };
    tick();
  }
  function downloadAll(){
    const all = [];
    (_lastGroups||[]).forEach(g => (g.items||[]).forEach(it => all.push(it)));
    if (!all.length) return;
    let i = 0;
    const tick = () => {
      if (i >= all.length) return;
      downloadSingle(all[i++]);
      setTimeout(tick, 160);
    };
    tick();
  }
  document.getElementById('dl-all').addEventListener('click', downloadAll);

  /* ===== Fetch media ===== */
  async function loadMedia(){
    const fecha = document.getElementById('rl-fecha').value;
    const local = (document.getElementById('rl-local-select')?.value) || window.SESSION_LOCAL;
    if (!fecha || !local) return;
    const url = new URL('/files/summary_media', location.origin);
    url.searchParams.set('fecha', fecha);
    url.searchParams.set('local', local);
    const r = await fetch(url.toString(), {credentials:'same-origin', cache:'no-store'});
    if (!r.ok){ renderDocs([]); return; }
    const data = await r.json();
    renderDocs(data.groups || []);
  }

  /* ===== Dispara actualizaci√≥n de ambos paneles ===== */
  async function refreshAll(){
    const selectedLocal = (document.getElementById('rl-local-select')?.value) || window.SESSION_LOCAL;
    document.getElementById('rl-local-display').textContent = selectedLocal;
    document.getElementById('rl-actualizar')?.dispatchEvent(new Event('click'));
    await loadMedia();
    // Actualizar botones de auditor√≠a si es nivel 3
    if (window.ROLE_LEVEL >= 3 && window.actualizarBotonesAuditoria) {
      await window.actualizarBotonesAuditoria();
    }
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    // Fecha por defecto hoy si est√° vac√≠a
    const inFecha = document.getElementById('rl-fecha');
    if (!inFecha.value){
      const d = new Date(); const p=n=>String(n).padStart(2,'0');
      inFecha.value = `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;
    }
    await loadLocalesIfNeeded();
    await loadMedia();

    document.getElementById('rl-actualizar')?.addEventListener('click', async () => {
      await loadMedia();
      // Actualizar botones de auditor√≠a despu√©s de cargar datos
      if (window.ROLE_LEVEL >= 3 && window.actualizarBotonesAuditoria) {
        await window.actualizarBotonesAuditoria();
      }
    });
    document.getElementById('rl-fecha')?.addEventListener('change', refreshAll);
    const sel = document.getElementById('rl-local-select');
    if (sel) sel.addEventListener('change', refreshAll);

    // Manejar botones de Auditado y Carga Masiva (solo nivel 3)
    if (window.ROLE_LEVEL >= 3) {
      const btnAuditado = document.getElementById('rl-marcar-auditado');
      const btnCargaMasiva = document.getElementById('rl-carga-masiva');

      // Hacer la funci√≥n global para poder llamarla desde otros event listeners
      window.actualizarBotonesAuditoria = async function() {
        const local = (document.getElementById('rl-local-select')?.value) || window.SESSION_LOCAL;
        const fecha = document.getElementById('rl-fecha')?.value;

        console.log('üîç Actualizando botones auditor√≠a:', { local, fecha });

        if (!local || !fecha) {
          console.log('‚ö†Ô∏è Falta local o fecha');
          return;
        }

        try {
          // Verificar si el local est√° cerrado
          const resEstado = await fetch(`/estado_local?local=${encodeURIComponent(local)}&fecha=${encodeURIComponent(fecha)}`);
          const dataEstado = await resEstado.json();
          const localCerrado = dataEstado.ok && dataEstado.estado === 0;
          console.log('üìä Estado local:', dataEstado, 'localCerrado:', localCerrado);

          // Verificar si est√° auditado
          const urlAudit = `/api/estado_auditoria?local=${encodeURIComponent(local)}&fecha=${encodeURIComponent(fecha)}`;
          console.log('üîó URL auditor√≠a:', urlAudit);

          const resAudit = await fetch(urlAudit);
          const dataAudit = await resAudit.json();
          const auditado = dataAudit.success && dataAudit.auditado;
          console.log('‚úÖ Estado auditor√≠a:', dataAudit, 'auditado:', auditado);

          // Mostrar botones seg√∫n estado
          console.log('üéØ Evaluando botones:', {
            localCerrado,
            auditado,
            existeBtnAuditado: !!btnAuditado,
            existeBtnCargaMasiva: !!btnCargaMasiva
          });

          if (localCerrado && !auditado && btnAuditado) {
            console.log('‚úÖ Mostrando bot√≥n AUDITADO');
            btnAuditado.style.display = 'inline-block';
          } else if (btnAuditado) {
            console.log('‚ùå Ocultando bot√≥n AUDITADO');
            btnAuditado.style.display = 'none';
          }

          if (auditado && btnCargaMasiva) {
            console.log('‚úÖ Mostrando bot√≥n CARGA MASIVA');
            btnCargaMasiva.style.display = 'inline-block';
          } else if (btnCargaMasiva) {
            console.log('‚ùå Ocultando bot√≥n CARGA MASIVA (auditado:', auditado, ')');
            btnCargaMasiva.style.display = 'none';
          }
        } catch (e) {
          console.error('‚ùå Error verificando estado de auditor√≠a:', e);
        }
      };

      // Ejecutar al cargar
      await window.actualizarBotonesAuditoria();

      // Bot√≥n Marcar Auditado
      btnAuditado?.addEventListener('click', async () => {
        const local = (document.getElementById('rl-local-select')?.value) || window.SESSION_LOCAL;
        const fecha = document.getElementById('rl-fecha')?.value;

        if (!confirm(`¬øConfirmar que el local "${local}" para la fecha ${fecha} est√° AUDITADO?\n\nDespu√©s de esto NO se podr√°n realizar m√°s cambios.`)) {
          return;
        }

        try {
          const res = await fetch('/api/marcar_auditado', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ local, fecha })
          });
          const data = await res.json();
          console.log('üîí Respuesta marcar_auditado:', data);

          if (data.success) {
            alert('‚úÖ Local marcado como AUDITADO');
            await actualizarBotonesAuditoria();
            await loadMedia(); // Refrescar datos
          } else {
            alert('‚ùå Error: ' + (data.msg || 'No se pudo marcar como auditado'));
          }
        } catch (e) {
          alert('‚ùå Error de red: ' + e.message);
        }
      });

      // Bot√≥n Carga Masiva
      btnCargaMasiva?.addEventListener('click', () => {
        const localSelect = document.getElementById('rl-local-select');
        const fechaInput = document.getElementById('rl-fecha');

        const local = localSelect?.value || window.SESSION_LOCAL;
        const fecha = fechaInput?.value;

        console.log('üîç Carga Masiva - Elementos:', {
          localSelect,
          fechaInput,
          'localSelect.value': localSelect?.value,
          'fechaInput.value': fechaInput?.value,
          'window.SESSION_LOCAL': window.SESSION_LOCAL,
          'local final': local,
          'fecha final': fecha
        });

        if (!local || !fecha) {
          alert(`‚ö†Ô∏è Error: Faltan par√°metros\nLocal: "${local}"\nFecha: "${fecha}"`);
          return;
        }

        // Redirigir a /auditoria con par√°metros
        const url = `/auditoria?local=${encodeURIComponent(local)}&fecha=${encodeURIComponent(fecha)}`;
        console.log('üîó Redirigiendo a:', url);

        // Confirmar antes de redirigir (temporal para debugging)
        if (confirm(`¬øIr a Carga Masiva?\nLocal: ${local}\nFecha: ${fecha}\nURL: ${url}`)) {
          window.location.href = url;
        }
      });
    }
  });
  </script>

  <!-- Tu JS existente para rellenar el RESUMEN NUM√âRICO -->
  <script src="{{ url_for('static', filename='js/resumen_local.js') }}"></script>
</body>
</html>
