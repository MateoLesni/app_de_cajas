<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema de Gesti√≥n de Ventas</title>

  <!-- Mant√©n tu CSS externo tal como lo tengas -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">

  <!-- Solo estilos nuevos: fondo y date picker moderno -->
  <style>
    /* ===== Tema r√°pido (pod√©s cambiar --page-bg a tu gusto) ===== */
    :root{
      --page-bg: #ffffff;      /* ‚Üê Cambi√° este color de fondo general */
      --date-accent: #0ea5e9;  /* Color principal del date */
    }
    body{ background: var(--page-bg); }

    /* ===== Date input moderno ===== */
    #fechaGlobal.date-modern{
      -webkit-appearance: none;
      appearance: none;
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 10px 44px 10px 12px; /* espacio para el √≠cono */
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(2,6,23,.08);
      transition: box-shadow .2s, border-color .2s, transform .06s;
    }
    #fechaGlobal.date-modern:hover{
      box-shadow: 0 3px 12px rgba(2,6,23,.12);
    }
    #fechaGlobal.date-modern:focus{
      outline: none;
      border-color: var(--date-accent);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--date-accent) 28%, transparent);
    }
    /* √çcono del calendario (WebKit/Blink) */
    #fechaGlobal.date-modern::-webkit-calendar-picker-indicator{
      background-image: url("data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' fill='none' stroke='%230ea5e9' stroke-width='2'/%3E%3Cpath d='M16 2v4M8 2v4M3 10h18' stroke='%230ea5e9' stroke-width='2' fill='none'/%3E%3Crect x='7' y='14' width='4' height='4' rx='1' fill='%230ea5e9'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 20px 20px;
      padding-right: 8px; /* espacio para el √≠cono */
    }
    /* Ajuste leve de campos internos para WebKit */
    #fechaGlobal.date-modern::-webkit-datetime-edit,
    #fechaGlobal.date-modern::-webkit-datetime-edit-year-field,
    #fechaGlobal.date-modern::-webkit-datetime-edit-month-field,
    #fechaGlobal.date-modern::-webkit-datetime-edit-day-field{
      padding: 0 2px;
    }
  </style>
</head>
<body>
  <!-- ===== Layout con Sidebar fija + Main ===== -->
  <div id="app" class="ui-scale layout">

    <!-- ===== Sidebar izquierda ===== -->
    <aside class="sidebar" role="navigation" aria-label="Barra lateral">
      <div class="sidebar__brand">
        <div class="brand-mark" aria-hidden="true">NG</div>
        <div class="brand-meta">
          <strong>Sistema</strong>
          <span>Gesti√≥n de Flujo de Cajas</span>
        </div>
      </div>

      <nav class="sidebar__nav">
        <!-- Botones pedidos: ‚ÄúResumen Local‚Äù, ‚ÄúReportes‚Äù -->
        <a class="nav-item" href="{{ url_for('resumen_local') }}">
          <span class="nav-dot" aria-hidden="true"></span>
          Resumen Local
        </a>

        <!-- Opcionales (puedes quitarlos si no los quer√©s en la barra) -->
        <a class="nav-item is-active" href="{{ url_for('index') }}">
          <span class="nav-dot" aria-hidden="true"></span>
          Carga de Datos
        </a>

      <!-- Grupo: Reporter√≠a (desplegable) -->
      <div class="nav-group {% if request.path.startswith('/reporteria') %}is-open{% endif %}">
        <!-- Toggle con el MISMO look de .nav-item -->
        <a href="javascript:void(0)"
          id="navReportes"
          class="nav-item nav-toggle {% if request.path.startswith('/reporteria') %}is-active{% endif %}"
          aria-expanded="{% if request.path.startswith('/reporteria') %}true{% else %}false{% endif %}">
          <span class="nav-dot" aria-hidden="true"></span>
          <span>Reporter√≠a</span>
          <!-- caret -->
          <svg class="nav-caret" width="14" height="14" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              aria-hidden="true" focusable="false" style="margin-left:auto;">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </a>

        <!-- Subitems con leve sangr√≠a -->
        <div class="nav-sub">
          <a class="nav-item nav-sub-item {% if request.path == url_for('ui_reporteria_remesas') %}is-active{% endif %}"
            href="{{ url_for('ui_reporteria_remesas') }}">
            <span class="nav-dot" aria-hidden="true"></span>
            Remesas
          </a>

          <a class="nav-item nav-sub-item {% if request.path == url_for('ui_reporteria_remesas') %}is-active{% endif %}"
            href="{{ url_for('ui_reporteria_remesas') if false else '#' }}">
            <span class="nav-dot" aria-hidden="true"></span>
            Cuentas Corrientes
          </a>
        </div>
      </div>

      <div class="sidebar__footer">
        <a class="nav-ghost" href="{{ url_for('logout') }}">Cerrar Sesi√≥n</a>
      </div>

      <!-- Toggle para mobile (opcional) -->
      <button class="sidebar__toggle" id="toggleSidebar" aria-label="Abrir/cerrar men√∫">‚ò∞</button>
    </aside>
    <!-- ===== /Sidebar ===== -->

    <!-- ===== Main ===== -->
    <main class="main">
      <div class="container">
        <!-- Notificaci√≥n flotante -->
        <div id="alertaFlotante"></div>

        <!-- Encabezado -->
        <div class="header">
          <div class="header-info">
            <div class="info-item"><span class="label">Fecha:</span> <span id="currentDate" class="value"></span></div>
            <div class="info-item"><span class="label">Usuario:</span> <span id="currentUser" class="value">{{ session['username'] }}</span></div>
            <div class="info-item"><span class="label">Local:</span> <span id="userLocal" class="value">{{ session['local'] }}</span></div>
            <div class="info-item"><span class="label">Sociedad:</span> <span id="userSociedad" class="value">{{ session['society']}}</span></div>
          </div>
          <div class="header-buttons">
            <a href="{{ url_for('index') }}" class="btn-header">Inicio</a>
            <a href="{{ url_for('logout') }}" class="btn-header">Cerrar Sesi√≥n</a>
          </div>
        </div>

        <div class="form-group">
          <label for="turnoSelect">Seleccion√° un turno:</label>
          <select id="turnoSelect" class="form-control" required>
            {% for t in turnos %}
              <option value="{{ t|trim|e }}">{{ t|trim|e }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label for="cajaSelect">Seleccion√° una caja:</label>
          <select id="cajaSelect" class="form-control" required>
            {% for i in range(1, cantidad_cajas + 1) %}
              <option value="Caja {{ i }}">Caja {{ i }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label for="fechaGlobal" class="form-label">Seleccion√° una fecha de carga:</label>
          <input type="date" id="fechaGlobal" class="form-control date-modern" required>
        </div>

        <!-- Tabs -->
        <div class="tabs-container">
          <div class="tabs">
            <button class="tab-btn" data-tab="cierre-caja-container">Resumen de Caja</button>
            <button class="tab-btn active" data-tab="ventasTab">Ventas</button>
            <button class="tab-btn" data-tab="mercadopago">MercadoPago</button>
            <button class="tab-btn" data-tab="tarjetas">Tarjetas</button>
            <button class="tab-btn" data-tab="remesas">Remesas</button>
            <button class="tab-btn" data-tab="gastos">Gastos</button>
            <button class="tab-btn" data-tab="rappiTab">Rappi</button>
            <button class="tab-btn" data-tab="pedidosyaTab">PedidosYa</button>
          </div>

          <!-- Resumen de Caja -->
          <div id="cierre-caja-container" class="tab-pane">
            <h2 class="cierre-title">Cierre de Caja - Detalle Diario</h2>

            <div class="cierre-acciones" style="margin: 12px 0; display:flex; gap:12px; align-items:center;">
              <button type="button" id="btnCerrarCaja" class="btn-cerrar-caja">üîí Cerrar Caja</button>
              <span id="badgeEstadoCaja" class="badge-estado badge-abierta">Abierta</span>
            </div>

            <div class="cierre-grid">
              <div class="cierre-section">
                <table class="cierre-table">
                  <thead><tr><th colspan="2">RESUMEN</th></tr></thead>
                  <tbody>
                    <tr><td>Venta Total</td><td class="valor" id="resVentaTotal">$ 0,00</td></tr>
                    <tr><td>Total Cobrado</td><td class="valor" id="totalCobrado">$ 0,00</td></tr>
                    <tr><td>Diferencia</td><td class="valor" id="diferencia">$ 0,00</td></tr>
                  </tbody>
                </table>
              </div>

              <div class="cierre-section">
                <table class="cierre-table">
                  <thead><tr><th colspan="2">VENTAS</th></tr></thead>
                  <tbody>
                    <tr><td>Vta Z</td><td class="valor" id="resVtaZ">$ 0,00</td></tr>
                    <tr><td>Discovery</td><td class="valor" id="resDiscovery">$ 0,00</td></tr>
                  </tbody>
                </table>
              </div>

              <div class="cierre-section">
                <table class="cierre-table">
                  <thead><tr><th colspan="2">INFORMACI√ìN</th></tr></thead>
                  <tbody>
                    <tr><td>Efectivo</td><td class="valor" id="resEfectivo">$ 0,00</td></tr>
                    <tr><td>Tarjeta</td><td class="valor" id="resTarjeta">$ 0,00</td></tr>
                    <tr><td>Mercado Pago</td><td class="valor" id="resMercadoPago">$ 0,00</td></tr>
                    <tr><td>Rappi</td><td class="valor" id="resRappi">$ 0,00</td></tr>
                    <tr><td>PedidosYa</td><td class="valor" id="resPedidosYa">$ 0,00</td></tr>
                    <tr><td>Gastos</td><td class="valor" id="resGastos">$ 0,00</td></tr>
                    <tr><td>Cuenta Cte.</td><td class="valor" id="rescuentaCte">$ 0,00</td></tr>
                    <tr><td>TIPs</td><td class="valor" id="resTips">$ 0,00</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Ventas -->
          <div id="ventasTab" class="tab-pane active">
            <h2>Registro de Ventas</h2>

            <!-- FORM 1: Venta Total (Sistema) -->
            <form id="ventasFormBase" class="form-container">
              <div class="form-group">
                <label for="ventaTotalSistemaInput">Venta total de la caja (Sistema)</label>
                <div class="input-money">
                  <span>$</span>
                  <input type="text" id="ventaTotalSistemaInput" class="form-control input-moneda" placeholder="0,00" autocomplete="off">
                </div>
              </div>
              <div class="form-actions">
                <button type="button" id="btnGuardarBase" class="btn-custom btn-save">üíæ Guardar</button>
                <span id="msgBase" class="form-msg"></span>
              </div>
            </form>

            <div class="soft-divider"></div>

            <!-- FORM 2: Comprobantes Z -->
            <form id="ventasZForm" class="form-container">
              <div class="grid-3">
                <div class="form-group">
                  <label for="puntoVentaInput">Punto de venta</label>
                  <input type="text" id="puntoVentaInput" class="form-control" placeholder="Ej: 0001" autocomplete="off">
                </div>
                <div class="form-group">
                  <label for="numeroZInput">N√∫mero de Z</label>
                  <input type="text" id="numeroZInput" class="form-control" placeholder="Ej: 123" autocomplete="off">
                </div>
                <div class="form-group">
                  <label for="montoZInput">Monto</label>
                  <div class="input-money">
                    <span>$</span>
                    <input type="text" id="montoZInput" class="form-control input-moneda" placeholder="0,00" autocomplete="off">
                  </div>
                </div>
              </div>
              <div class="form-actions">
                <button type="button" id="btnGuardarZ" class="btn-custom btn-save">üíæ Guardar</button>
                <span id="msgZ" class="form-msg"></span>
              </div>
            </form>

            <!-- Uploader Ventas Z -->
            <div id="uploader-ventas-z" class="img-uploader" data-title="Adjuntar im√°genes de Ventas Z" data-tab="ventas_z" style="margin-top:12px;"></div>
            <div id="galeria-ventas-z" class="iu-grid" style="margin-top:8px;"></div>

            <div class="soft-divider"></div>

            <!-- Tabla: Venta Total -->
            <div class="preview-block">
              <h4>Venta total (Sistema) registrada</h4>
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Venta total (Sistema)</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="tablaPreviewBase"></tbody>
              </table>
            </div>

            <div class="soft-divider"></div>

            <!-- Tabla: Comprobantes Z -->
            <div class="preview-block">
              <h4>Comprobantes Z registrados</h4>
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Pto. venta</th>
                    <th>N¬∞ Z</th>
                    <th>Monto</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="tablaPreviewZ"></tbody>
              </table>
            </div>
          </div>

          <!-- Estilos m√≠nimos -->
          <style>
            .form-container { margin-top: 8px; }
            .form-group { margin-bottom: 10px; }
            .form-group label { display:block; font-weight:600; margin-bottom:4px; }
            .form-actions { display:flex; align-items:center; gap:10px; margin-top: 8px; }
            .form-msg { font-weight:600; }
            .soft-divider { height: 1px; margin: 16px 0; background: linear-gradient(90deg,#e5e7eb,#cbd5e1,#e5e7eb); }
            .grid-3 { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px; }
            .input-money { display:flex; align-items:center; gap:6px; }
            .input-money > span { font-weight:600; }
            .btn-custom.btn-save { padding:6px 12px; border-radius:8px; border:1px solid #d1d5db; background:#0ea5e9; color:#fff; font-weight:600; }
            .btn-custom[disabled] { opacity:.5; pointer-events:none; }
            .table { width:100%; border-collapse: collapse; }
            .table th, .table td { border:1px solid #e5e7eb; padding:8px; }
            .table thead th { background:#f8fafc; }
            .table .row-ok { background:#e7f7ea; }
            .btn-icon { padding:4px 8px; border-radius:6px; border:1px solid #d1d5db; background:#fff; cursor:pointer; }
            .btn-icon + .btn-icon { margin-left:4px; }
          </style>

          <!-- MercadoPago -->
          <div id="mercadopago" class="tab-pane">
            <h2>Registro de MercadoPago</h2>

            <!-- Terminales -->
            <div class="form-group">
              <button type="button" class="btn-submit" id="btnMostrarCrearTerminal">‚ûï Crear terminal</button>
              <div id="formCrearTerminal" style="display: none; margin-top: 10px;">
                <input type="text" id="nuevoTerminal" class="form-control" placeholder="Nombre de la terminal" style="margin-bottom: 10px;">
                <button type="button" class="btn-custom btn-save" id="btnOkCrearTerminal">‚úÖ Ok</button>
                <button type="button" class="btn-submit" id="btnCancelarCrearTerminal">‚ùå Cancelar</button>
              </div>
            </div>

            <div class="form-group" id="grupoTerminalActivo" style="display: none;">
              <label for="terminalActivo">Seleccionar Terminal Activa:</label>
              <select id="terminalActivo" class="form-control"></select>
            </div>

            <p id="terminalActivaTexto" style="font-weight: bold; margin-bottom: 20px;"></p>

            <!-- Formulario -->
            <form id="mercadoPagoForm">
              <div class="form-group">
                <label for="mpImporte">Importe:</label>
                <input type="text" id="mpImporte" class="form-control" required>
              </div>
              <div class="form-group">
                <label><input type="checkbox" id="esTip"> Es una propina (TIP)</label>
              </div>
              <div class="form-group" id="grupoComprobante">
                <label for="mpComprobante">N¬∞ Comprobante:</label>
                <input type="text" id="mpComprobante" class="form-control">
              </div>
              <button type="submit" class="btn-submit">‚ûï A√±adir</button>
            </form>

            <!-- Uploader MercadoPago -->
            <div id="uploader-mercadopago" class="img-uploader" data-title="Adjuntar im√°genes de MercadoPago" data-tab="mercadopago" style="margin-top:12px;"></div>
            <div id="galeria-mercadopago" class="iu-grid" style="margin-top:8px;"></div>

            <div>
              <h4 style="margin-top: 30px;">Comprobantes a√±adidos para esta caja:</h4>
              <table>
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th>Terminal</th>
                    <th>N¬∞ Comprobante/Cierre de Lote</th>
                    <th>Importe</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="tablaPreviewMercadoPago"></tbody>
              </table>
              <button id="btnGuardarMercadoPago" class="btn-custom btn-save">üíæ Guardar</button>
            </div>
          </div>

          <!-- Rappi -->
          <div id="rappiTab" class="tab-pane">
            <h2>Registro de Rappi</h2>

            <div id="previewRappi" style="margin-bottom: 20px;">
              <h4>Comprobantes a√±adidos para esta caja:</h4>
              <table>
                <thead><tr><th>Fecha</th><th>N¬∞ Comprobante</th><th>Monto</th><th>Acciones</th></tr></thead>
                <tbody id="tablaPreviewRappi"></tbody>
              </table>
            </div>

            <form id="rappiForm" class="form-container">
              <input type="hidden" id="idxEdicionRappi" value="-1">
              <div class="form-group">
                <label for="transaccionRappi">N¬∞ Comprobante:</label>
                <input type="text" id="transaccionRappi" name="transaccionRappi" class="form-control" required>
              </div>
              <div class="form-group">
                <label for="montoRappi">Monto:</label>
                <div class="input-money"><span>$</span>
                  <input type="text" id="montoRappi" name="montoRappi" class="form-control moneda currency-input" placeholder="0,00" required>
                </div>
              </div>
              <button type="button" id="btnAnadirRappi" class="btn-submit">‚ûï A√±adir Comprobante</button>
              <button type="button" id="btnActualizarRappi" class="btn-submit" style="display:none; background-color:#28a745;">Actualizar Comprobante</button>
            </form>

            <button type="button" id="guardarRappiBD" class="btn-custom btn-save" style="margin-top: 20px;">üíæ Guardar Comprobantes</button>
            <div id="respuestaRappi" style="margin-top: 10px;"></div>

            <!-- Uploader Rappi -->
            <div id="uploader-rappi" class="img-uploader" data-title="Adjuntar im√°genes de Rappi" data-tab="rappi" style="margin-top:12px;"></div>
            <div id="galeria-rappi" class="iu-grid" style="margin-top:8px;"></div>
          </div>

          <!-- PedidosYa -->
          <div id="pedidosyaTab" class="tab-pane">
            <h2>Registro de PedidosYa</h2>

            <div id="previewPedidosYa" style="margin-bottom: 20px;">
              <h4>Comprobantes a√±adidos para esta caja:</h4>
              <table>
                <thead><tr><th>Fecha</th><th>N¬∞ Comprobante</th><th>Monto</th><th>Acciones</th></tr></thead>
                <tbody id="tablaPreviewPedidosYa"></tbody>
              </table>
            </div>

            <form id="pedidosyaForm" class="form-container">
              <input type="hidden" id="idxEdicionPedidosYa" value="-1">
              <div class="form-group">
                <label for="transaccionPedidosYa">N¬∞ Comprobante:</label>
                <input type="text" id="transaccionPedidosYa" name="transaccionPedidosYa" class="form-control" required>
              </div>
              <div class="form-group">
                <label for="montoPedidosYa">Monto:</label>
                <div class="input-money"><span>$</span>
                  <input type="text" id="montoPedidosYa" name="montoPedidosYa" class="form-control moneda currency-input" placeholder="0,00" required>
                </div>
              </div>
              <button type="button" id="btnAnadirPedidosYa" class="btn-submit">‚ûï A√±adir Comprobante</button>
              <button type="button" id="btnActualizarPedidosYa" class="btn-submit" style="display:none; background-color:#28a745;">Actualizar Comprobante</button>
            </form>

            <button type="button" id="guardarPedidosYaBD" class="btn-custom btn-save" style="margin-top: 20px;">üíæ Guardar Comprobantes</button>
            <div id="respuestaPedidosYa" style="margin-top: 10px;"></div>

            <!-- Uploader PedidosYa -->
            <div id="uploader-pedidosya" class="img-uploader" data-title="Adjuntar im√°genes de PedidosYa" data-tab="pedidosya" style="margin-top:12px;"></div>
            <div id="galeria-pedidosya" class="iu-grid" style="margin-top:8px;"></div>
          </div>

          <!-- Tarjetas -->
          <div id="tarjetas" class="tab-pane">
            <h2>Registro de Tarjetas</h2>

            <div class="form-group">
              <label for="nuevoLote">Nuevo Lote:</label>
              <input type="text" id="nuevoLote" placeholder="Ej: 001">
              <button type="button" id="btnAgregarLote" class="btn-submit">‚ûï A√±adir Lote</button>
            </div>

            <div class="form-group">
              <label for="selectLote">Lote activo:</label>
              <select id="selectLote" style="display: none;"></select>
              <span id="infoLoteActivo">Lote actual: Sin lote</span>
            </div>

            <form id="tarjetasForm" class="form-container">
              <table style="width: 100%; margin-bottom: 20px;">
                <thead><tr><th>Tarjeta</th><th>Monto</th></tr></thead>
                <tbody>
                  <tr class="tarjeta-row" data-tarjeta="VISA"><td>VISA</td><td><input type="text" class="input-monto currency-input" placeholder="0,00"></td></tr>
                  <tr class="tarjeta-row" data-tarjeta="VISA DEBITO"><td>VISA D√âBITO</td><td><input type="text" class="input-monto currency-input" placeholder="0,00"></td></tr>
                  <tr class="tarjeta-row" data-tarjeta="VISA PREPAGO"><td>VISA PREPAGO</td><td><input type="text" class="input-monto currency-input" placeholder="0,00"></td></tr>
                  <tr class="tarjeta-row" data-tarjeta="MASTERCARD"><td>MASTERCARD</td><td><input type="text" class="input-monto currency-input" placeholder="0,00"></td></tr>
                  <tr class="tarjeta-row" data-tarjeta="MASTERCARD DEBITO"><td>MASTERCARD D√âBITO</td><td><input type="text" class="input-monto currency-input" placeholder="0,00"></td></tr>
                  <tr class="tarjeta-row" data-tarjeta="MASTERCARD PREPAGO"><td>MASTERCARD PREPAGO</td><td><input type="text" class="input-monto currency-input" placeholder="0,00"></td></tr>
                  <tr class="tarjeta-row" data-tarjeta="CABAL"><td>CABAL</td><td><input type="text" class="input-monto currency-input" placeholder="0,00"></td></tr>
                  <tr class="tarjeta-row" data-tarjeta="CABAL DEBITO"><td>CABAL D√âBITO</td><td><input type="text" class="input-monto currency-input" placeholder="0,00"></td></tr>
                  <tr class="tarjeta-row" data-tarjeta="AMEX"><td>AMEX</td><td><input type="text" class="input-monto currency-input" placeholder="0,00"></td></tr>
                  <tr class="tarjeta-row" data-tarjeta="MAESTRO"><td>MAESTRO</td><td><input type="text" class="input-monto currency-input" placeholder="0,00"></td></tr>
                  <tr class="tarjeta-row" data-tarjeta="NARANJA"><td>NARANJA</td><td><input type="text" class="input-monto currency-input" placeholder="0,00"></td></tr>
                  <tr class="tarjeta-row" data-tarjeta="DECIDIR"><td>DECIDIR</td><td><input type="text" class="input-monto currency-input" placeholder="0,00"></td></tr>
                  <tr class="tarjeta-row" data-tarjeta="DINERS"><td>DINERS</td><td><input type="text" class="input-monto currency-input" placeholder="0,00"></td></tr>
                  <tr class="tarjeta-row" data-tarjeta="PAGOS INMEDIATOS"><td>PAGOS INMEDIATOS</td><td><input type="text" class="input-monto currency-input" placeholder="0,00"></td></tr>
                  <tr class="tarjeta-row" data-tarjeta="TIPS"><td>TIPS</td><td><input type="text" class="input-monto currency-input" placeholder="0,00"></td></tr>
                </tbody>
              </table>
              <button type="submit" class="btn-submit">‚ûï A√±adir Tarjetas</button>
            </form>

            <!-- Uploader Tarjetas -->
            <div id="uploader-tarjetas" class="img-uploader" data-title="Adjuntar im√°genes de Tarjetas" data-tab="tarjetas" style="margin-top:12px;"></div>
            <div id="galeria-tarjetas" class="iu-grid" style="margin-top:8px;"></div>

            <div id="labelTarjetasCargadas" style="margin-top: 10px; font-weight: bold; color: green; display: none;">
              üü© Tarjetas ya cargadas
            </div>

            <div>
              <h4>Vista previa de tarjetas:</h4>
              <table style="width: 100%;" border="1">
                <thead>
                  <tr>
                    <th>Tarjeta</th>
                    <th>Terminal / Lote</th>
                    <th>Monto</th>
                    <th>TIP</th>
                  </tr>
                </thead>
                <tbody id="tablaPreviewTarjetas"></tbody>
              </table>
            </div>

            <div style="margin-top: 10px; font-weight: bold;">
              Total cargadas hoy (verde): <span id="totalCargadasHoy">$0,00</span><br>
              Total nuevas a guardar: <span id="totalNuevas">$0,00</span>
            </div>

            <button type="button" id="btnGuardarTarjetas" class="btn-custom btn-save" style="margin-top: 20px;">üíæ Guardar Tarjetas</button>
          </div>

          <!-- Remesas -->
          <div id="remesas" class="tab-pane">
            <h2>Registro de Remesas</h2>

            <div id="previewRemesas" style="margin-bottom: 20px;">
              <h4>Remesas a√±adidas para esta caja:</h4>
              <table>
                <thead>
                  <tr>
                    <th>Fecha</th><th>Remesa</th><th>Precinto</th><th>Monto</th>
                    <th>Retirada</th><th>Retirada por</th><th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="tablaPreviewRemesas"></tbody>
              </table>
            </div>

            <!-- Formulario de remesas -->
            <form id="remesaForm" class="form-container">
              <input type="hidden" id="cajaActual" name="caja">
              <input type="hidden" id="editIndex" value="">
              <div class="form-group">
                <label for="nro_remesa">N¬∞ Remesa:</label>
                <input type="text" id="nro_remesa" name="nro_remesa" required>
              </div>
              <div class="form-group">
                <label for="precinto">N¬∞ Precinto:</label>
                <input type="text" id="precinto" name="precinto" required>
              </div>
              <div class="form-group">
                <label for="monto">Monto:</label>
                <div class="input-money"><span>$</span>
                  <input type="text" id="monto" name="monto" class="currency-input" placeholder="0,00" required>
                </div>
              </div>
              <div class="form-group">
                <label for="retirada">¬øRetirada?</label>
                <select id="retirada" name="retirada" required>
                  <option value="S√≠">S√≠</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="form-group">
                <label for="retirada_por">Retirada por:</label>
                <input type="text" id="retirada_por" name="retirada_por">
              </div>
              <button type="button" id="btnAnadirRemesa" class="btn-submit">‚ûï A√±adir Remesa</button>
              <button type="button" id="btnActualizarRemesa" class="btn-submit" style="display:none; background-color:#28a745;">Actualizar Remesa</button>
            </form>

            <!-- Uploader Remesas -->
            <div id="uploader-remesas" class="img-uploader" data-title="Adjuntar im√°genes de Remesas" data-tab="remesas" style="margin-top:16px;"></div>
            <div id="galeria-remesas" class="iu-grid" style="margin-top:8px;"></div>

            <!-- Bot√≥n GUARDAR (fuera del form) -->
            <button type="button" id="btnGuardarRemesas" class="btn-custom btn-save" style="margin-top: 20px;">üíæ Guardar Remesas</button>
            <div id="respuestaRemesa" style="margin-top: 10px;"></div>
          </div>

          <!-- Gastos -->
          <div id="gastos" class="tab-pane">
            <h2>Registro de Gastos</h2>

            <div id="previewGastos" style="margin-bottom: 20px;">
              <h4>Comprobantes a√±adidos para esta caja:</h4>
              <table>
                <thead><tr><th>Fecha</th><th>Tipo de Gasto</th><th>Monto</th><th>Acciones</th></tr></thead>
                <tbody id="tablaPreviewGastos"></tbody>
              </table>
            </div>

            <form id="gastosForm" class="form-container">
              <input type="hidden" id="idxEdicionGastos" value="-1">
              <div class="form-group">
                <label for="tipoGasto">Tipo de Gasto:</label>
                <input type="text" id="tipoGasto" name="tipoGasto" class="form-control" required>
              </div>
              <div class="form-group">
                <label for="montoGastos">Monto:</label>
                <div class="input-money"><span>$</span>
                  <input type="text" id="montoGastos" name="montoGastos" class="form-control moneda currency-input" placeholder="0,00" required>
                </div>
              </div>
              <button type="button" id="btnAnadirGastos" class="btn-submit">‚ûï A√±adir Comprobante</button>
              <button type="button" id="btnActualizarGastos" class="btn-submit" style="display:none; background-color:#28a745;">Actualizar Comprobante</button>
            </form>

            <!-- Uploader Gastos -->
            <div id="uploader-gastos" class="img-uploader" data-title="Adjuntar im√°genes de Gastos" data-tab="gastos" style="margin-top:12px;"></div>
            <div id="galeria-gastos" class="iu-grid" style="margin-top:8px;"></div>

            <button type="button" id="guardarGastosBD" class="btn-custom btn-save" style="margin-top: 20px;">üíæ Guardar Comprobantes</button>
            <div id="respuestaGastos" style="margin-top: 10px;"></div>
          </div>
        </div> <!-- /tabs-container -->
      </div> <!-- /container -->

      <!-- Modal confirmaci√≥n -->
      <div id="confirmationModal" class="modal">
        <div class="modal-content">
          <h2>Confirmaci√≥n</h2>
          <p id="modalMessage"></p>
          <div class="modal-buttons">
            <button id="btnConfirm" class="btn-confirm">Confirmar</button>
            <button id="btnCancel" class="btn-cancel">Cancelar</button>
          </div>
        </div>
      </div>
    </main>
    <!-- ===== /Main ===== -->
  </div>
  <!-- ===== /layout ===== -->

  <!-- Helpers de alerta y cierre de caja (SIN CAMBIOS de l√≥gica) -->
  <script>
  (function(){
    const alerta = document.getElementById('alertaFlotante');
    function toast(msg){
      if(!alerta){ alert(msg); return; }
      alerta.textContent = msg;
      alerta.style.display = 'block';
      alerta.classList.add('show');
      setTimeout(() => { alerta.classList.remove('show'); alerta.style.display='none'; }, 2000);
    }

    function getCtx(){
      return {
        local: (document.getElementById('userLocal')?.innerText || '').trim(),
        caja:  document.getElementById('cajaSelect')?.value || '',
        fecha: document.getElementById('fechaGlobal')?.value || '',
        turno: document.getElementById('turnoSelect')?.value || ''   // ‚Üê AHORA ENVIAMOS TURNO
      };
    }

    async function refrescarBadge(){
      const {local,caja,fecha,turno} = getCtx();
      if(!local || !caja || !fecha || !turno) return;
      try{
        const r = await fetch(`/estado_caja?local=${encodeURIComponent(local)}&caja=${encodeURIComponent(caja)}&fecha=${encodeURIComponent(fecha)}&turno=${encodeURIComponent(turno)}`);
        const data = await r.json();
        const badge = document.getElementById('badgeEstadoCaja');
        if(!badge) return;
        if((data.estado ?? 1) === 1){
          badge.textContent = 'Abierta';
          badge.classList.remove('badge-cerrada');
          badge.classList.add('badge-abierta');
        }else{
          badge.textContent = 'Cerrada';
          badge.classList.remove('badge-abierta');
          badge.classList.add('badge-cerrada');
        }
      }catch(e){ /* no-op */ }
    }

    const btn = document.getElementById('btnCerrarCaja');
    if(btn){
      btn.addEventListener('click', async () => {
        const {local,caja,fecha,turno} = getCtx();
        if(!local || !caja || !fecha || !turno){ toast('Seleccion√° Turno, Local, Caja y Fecha.'); return; }
        if(!confirm(`Vas a cerrar ${caja} (${turno}) del ${fecha} en ${local}. Luego de esto NO se podr√° editar ni borrar.\n\n¬øConfirm√°s?`)){
          return;
        }
        try{
          const r = await fetch('/cerrar_caja', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({local, caja, fecha, turno})
          });
          const data = await r.json();
          if(data.ok || data.closed || data.already_closed){
            toast('üîí Caja cerrada');
            refrescarBadge();
            if (window.OrqTabs) {
              window.OrqTabs.reloadActive();
            } else {
              document.dispatchEvent(new CustomEvent('caja:cerrada', { detail: { local, caja, fecha, turno }}));
            }
          }else{
            toast(data.msg || 'No se pudo cerrar la caja');
          }
        }catch(e){
          toast('Error de red al cerrar la caja');
        }
      });
    }

    window.addEventListener('DOMContentLoaded', refrescarBadge);
    document.getElementById('cajaSelect')?.addEventListener('change', refrescarBadge);
    document.getElementById('fechaGlobal')?.addEventListener('change', refrescarBadge);
    document.getElementById('turnoSelect')?.addEventListener('change', refrescarBadge);
  })();
  </script>
  <script>
  // 1=cajero, 2=encargado/adm, 3=auditor
  window.ROLE_LEVEL = {{ session['role_level']|int }};
</script>

  <!-- M√≥dulos existentes -->
  <script src="{{ url_for('static', filename='js/index.js') }}"></script>
  <script src="{{ url_for('static', filename='js/tarjetas.js') }}"></script>
  <script src="{{ url_for('static', filename='js/mercadopago.js') }}"></script>
  <script src="{{ url_for('static', filename='js/rappi.js') }}"></script>
  <script src="{{ url_for('static', filename='js/pedidosya.js') }}"></script>
  <script src="{{ url_for('static', filename='js/ventas.js') }}"></script>
  <script src="{{ url_for('static', filename='js/resumen.js') }}"></script>
  <script src="{{ url_for('static', filename='js/gastos.js') }}"></script>
  <script src="{{ url_for('static', filename='js/orquestador-tabs.js') }}"></script>

  <script>
  // calcula la base real del blueprint (ej: "/files" o "/api/files")
  window.ADJ_BASE = "{{ url_for('files.list_files')|replace('/list','') }}";
</script>

<!-- y reci√©n despu√©s el adjuntador -->
<script src="{{ url_for('static', filename='js/adjuntador.js') }}" defer></script>

  <!-- Toggle de sidebar en mobile -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const grp = document.querySelector('.nav-group');
    const tgl = document.getElementById('navReportes');
    if (grp && tgl) {
      tgl.addEventListener('click', (e) => {
        e.preventDefault();
        const open = grp.classList.toggle('is-open');
        tgl.setAttribute('aria-expanded', open ? 'true' : 'false');
      });
    }
  });
  </script>

  <!-- Estilos del adjuntador (dejamos CSS; se removi√≥ todo el JS inline del adjuntador) -->
  <style id="iu-style-v2">
    .img-uploader { position: static; z-index: 0; }
    .img-uploader .iu-wrap{border:1px dashed #cbd5e1;border-radius:12px;padding:12px;background:#fafafa}
    .img-uploader .iu-header{display:flex;align-items:center;gap:8px;justify-content:space-between;margin-bottom:8px;flex-wrap:wrap}
    .img-uploader .iu-title{font-weight:600}
    .img-uploader .iu-chip{font-size:12px;background:#eef2ff;color:#3730a3;border-radius:999px;padding:4px 10px}
    .img-uploader .iu-actions{display:flex;gap:8px}
    .img-uploader .iu-btn{border:1px solid #cbd5e1;background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
    .img-uploader .iu-btn:hover{background:#f1f5f9}
    .img-uploader .iu-dropzone{border:2px dashed #94a3b8;border-radius:12px;padding:16px;text-align:center;color:#475569;background:#fff}
    .img-uploader .iu-dropzone.iu-drag{background:#eff6ff;border-color:#60a5fa}
    .img-uploader .iu-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-top:10px}
    .img-uploader .iu-thumb{position:relative;border:1px solid #e5e7eb;border-radius:10px;overflow:hidden;background:#fff}
    .img-uploader .iu-thumb img{display:block;width:100%;height:100px;object-fit:cover}
    .img-uploader .iu-name{display:block;font-size:12px;padding:6px 8px;color:#334155;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .img-uploader .iu-remove{position:absolute;top:6px;right:6px;border:none;background:#ef4444;color:#fff;border-radius:999px;width:22px;height:22px;line-height:22px;text-align:center;cursor:pointer}
  </style>

  <!-- Adjuntador externo (nuevo) -->
  <script>window.ADJ_ALLOW_DELETE = true;</script>
  <script src="{{ url_for('static', filename='js/fecha_hoy_index.js') }}"></script>   
  <script src="{{ url_for('static', filename='js/adjuntador.js') }}"></script>
  <script src="{{ url_for('static', filename='js/orqtabs_init.js') }}" defer></script>



</body>
</html>
