<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AP Efectivo</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- jsPDF para generar PDFs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

  <style>
    .tesoreria-container {
        padding: 8px;
        max-width: 100%;
        overflow-x: auto;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        padding-bottom: 6px;
        border-bottom: 1px solid #d1d5db;
        width: 100%;
    }

    .header-section h1 {
        color: #374151;
        font-size: 14px;
        margin: 0;
        font-weight: 600;
    }

    .controls-section {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .date-selector {
        display: flex;
        gap: 6px;
        align-items: center;
        font-size: 11px;
    }

    .date-selector label {
        color: #4b5563;
        font-weight: 600;
    }

    .date-selector input[type="date"] {
        padding: 3px 6px;
        border: 1px solid #9ca3af;
        border-radius: 3px;
        font-size: 10px;
        color: #374151;
    }

    .btn-actualizar {
        background: #1e88e5;
        color: white;
        border: none;
        padding: 4px 10px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 10px;
        font-weight: 600;
        transition: all 0.2s;
    }

    .btn-actualizar:hover {
        background: #1565c0;
    }

    .date-indicator {
        background: #6b7280;
        color: white;
        padding: 3px 8px;
        border-radius: 2px;
        font-weight: 600;
        font-size: 10px;
    }

    .segment-section {
        margin-bottom: 6px;
        width: 100%;
        max-width: 1000px;
        display: block;
    }

    .segment-title {
        background: #d1d5db;
        color: #1f2937;
        padding: 2px 6px;
        font-size: 10px;
        font-weight: 700;
        border: none;
        margin-top: 3px;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        margin-bottom: 2px;
        font-size: 11px;
        table-layout: fixed;
    }

    .data-table thead {
        background: #d1d5db;
    }

    .data-table th {
        padding: 3px 8px;
        text-align: center;
        font-weight: 700;
        font-size: 10px;
        border: 1px solid #9ca3af;
        color: #4b5563;
        white-space: nowrap;
    }

    .data-table th.local-header {
        background: #d1d5db;
        text-align: left;
        white-space: normal;
        width: 15%;
    }

    .data-table th.date-header {
        background: #d1d5db;
    }

    .data-table th.saldo-header {
        background: #d1d5db;
    }

    .data-table tbody tr:nth-child(even) {
        background: white;
    }

    .data-table tbody tr:hover {
        background: #f9fafb;
    }

    .data-table td {
        padding: 3px 8px;
        text-align: center;
        border: 1px solid #d1d5db;
        font-size: 11px;
        line-height: 1.3;
    }

    .data-table td.local-name {
        text-align: left;
        font-weight: 400;
        color: #000000;
        padding-left: 8px;
        width: 15%;
    }

    .data-table td.amount {
        text-align: center;
        font-family: Arial, sans-serif;
        font-weight: 400;
        color: #000000;
    }

    /* Te√≥rico - texto negro */
    .teorico-value {
        color: #000000;
        font-weight: 400;
    }

    /* Real - gris clarito con fondo gris claro */
    .real-value {
        color: #000000;
        font-weight: 700;
        background: #f3f4f6;
    }

    /* Diferencia - con fondo gris m√°s oscuro que Real */
    .diff-value {
        font-weight: 700;
        color: #000000;
        background: #e5e7eb;
    }

    .diff-value.positivo {
        color: #16a34a !important;
        font-weight: 700;
    }

    .diff-value.negativo {
        color: #dc2626 !important;
        font-weight: 700;
    }

    .saldo-value {
        color: #000000;
        font-weight: 700;
    }

    .ap-proyectada-value {
        color: #000000;
        font-weight: 700;
        background: #e5e7eb;
    }

    /* Secci√≥n No Enviados */
    .no-enviados-section {
        margin-top: 12px;
        padding-top: 8px;
        border-top: 2px solid #9ca3af;
        width: auto;
        display: block;
    }

    .no-enviados-title {
        background: #d1d5db;
        color: #1f2937;
        padding: 2px 6px;
        font-size: 10px;
        font-weight: 700;
        border: none;
        margin-bottom: 0;
    }

    .no-enviados-table {
        width: auto;
        border-collapse: collapse;
        background: white;
        font-size: 11px;
        table-layout: auto;
    }

    .no-enviados-table thead {
        background: #d1d5db;
    }

    .no-enviados-table th {
        padding: 3px 8px;
        text-align: center;
        font-weight: 700;
        font-size: 10px;
        border: 1px solid #9ca3af;
        color: #4b5563;
        white-space: nowrap;
        min-width: 80px;
    }

    .no-enviados-table tbody tr:nth-child(even) {
        background: white;
    }

    .no-enviados-table tbody tr:hover {
        background: #f9fafb;
    }

    .no-enviados-table td {
        padding: 3px 8px;
        border: 1px solid #d1d5db;
        text-align: center;
        line-height: 1.3;
        min-width: 80px;
    }

    .no-enviados-table td.local-col {
        text-align: left;
        font-weight: 400;
        color: #000000;
        min-width: auto;
        width: auto;
    }

    .no-enviados-table td.monto-col {
        text-align: right;
        font-family: Arial, sans-serif;
        font-weight: 400;
        color: #000000;
        min-width: 80px;
    }

    .no-enviados-table td.dias-col {
        font-weight: 400;
        color: #dc2626;
        min-width: 90px;
    }

    .loading-spinner {
        text-align: center;
        padding: 15px;
        font-size: 12px;
        color: #9ca3af;
    }

    .error-message {
        background: #dc2626;
        color: white;
        padding: 8px;
        border-radius: 2px;
        margin: 6px 0;
        text-align: center;
        font-size: 11px;
    }

    .empty-message {
        text-align: center;
        padding: 10px;
        color: #9ca3af;
        font-style: italic;
        font-size: 10px;
    }
  </style>
</head>
<body>
  <div id="app" class="ui-scale layout">
    <!-- Sidebar -->
    <aside class="sidebar" role="navigation" aria-label="Barra lateral">
      <div class="sidebar__brand">
        <div class="brand-mark" aria-hidden="true">NG</div>
        <div class="brand-meta">
          <strong>Sistema</strong>
          <span>Gesti√≥n de Tesorer√≠a</span>
        </div>
      </div>

      <nav class="sidebar__nav">
        {% if session.get('role_level', 1)|int >= 3 %}
          {# Para auditores: Inicio lleva a /auditor #}
          <a class="nav-item" href="{{ url_for('index') }}">
            <span class="nav-dot" aria-hidden="true"></span>
            Inicio
          </a>
        {% else %}
          {# Para tesorer√≠a: Inicio lleva a tesoreria_home_new #}
          <a class="nav-item" href="{{ url_for('tesoreria_home_new') }}">
            <span class="nav-dot" aria-hidden="true"></span>
            Inicio
          </a>
        {% endif %}

        <div class="nav-group is-open">
          <a href="javascript:void(0)"
             id="navReportes"
             class="nav-item nav-toggle is-active"
             aria-expanded="true">
            <span class="nav-dot" aria-hidden="true"></span>
            <span>Reporter√≠a</span>
            <svg class="nav-caret" width="14" height="14" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                 aria-hidden="true" focusable="false" style="margin-left:auto;">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </a>

          <div class="nav-sub">
            {% if session.get('role_level', 1)|int < 3 %}
              {# Solo mostrar "Remesas Tesorer√≠a" si NO es auditor #}
              <a class="nav-item nav-sub-item"
                 href="{{ url_for('reporte_remesas_tesoreria_page') }}">
                <span class="nav-dot" aria-hidden="true"></span>
                Remesas Tesorer√≠a
              </a>
            {% endif %}
            <a class="nav-item nav-sub-item is-active"
               href="{{ url_for('reporte_ap_efectivo_page') }}">
              <span class="nav-dot" aria-hidden="true"></span>
              AP Efectivo
            </a>
            <a class="nav-item nav-sub-item"
               href="{{ url_for('reporte_ap_efectivo_usd_page') }}">
              <span class="nav-dot" aria-hidden="true"></span>
              AP Efectivo USD
            </a>
            {% if nivel_usuario >= 4 %}
            <a class="nav-item nav-sub-item"
               href="{{ url_for('reporte_resumen_tesoreria_page') }}">
              <span class="nav-dot" aria-hidden="true"></span>
              AP Tesorer√≠a
            </a>
            <a class="nav-item nav-sub-item"
               href="{{ url_for('reporte_resumen_tesoreria_usd_page') }}">
              <span class="nav-dot" aria-hidden="true"></span>
              AP Tesorer√≠a USD
            </a>
            {% endif %}
          </div>
        </div>

        <div class="sidebar__footer">
          <a class="nav-ghost" href="{{ url_for('logout') }}">Cerrar Sesi√≥n</a>
        </div>
      </nav>
    </aside>

    <!-- Contenido principal -->
    <main class="content-main" role="main">
      <div class="tesoreria-container">
        <div class="header-section">
          <h1>AP Efectivo</h1>
          <div class="controls-section">
            <div class="date-selector">
              <label for="fechaConsulta">Fecha:</label>
              <input type="date" id="fechaConsulta" />
              <button class="btn-actualizar" id="btnActualizar">
                <i class="fas fa-sync-alt"></i> Actualizar
              </button>
              <button class="btn-actualizar" id="btnDescargarPDF" style="margin-left: 10px; background-color: #dc2626;">
                <i class="fas fa-file-pdf"></i> Descargar PDF
              </button>
            </div>
            <div class="date-indicator" id="dateIndicator">Cargando...</div>
          </div>
        </div>

        <div id="loadingSpinner" class="loading-spinner">
          <i class="fas fa-spinner fa-spin"></i> Cargando datos...
        </div>

        <div id="errorContainer" style="display: none;"></div>

        <div id="dataContainer" style="display: none; width: auto;">
          <!-- Los segmentos se generar√°n din√°micamente aqu√≠ -->
        </div>

        <!-- Secci√≥n No Enviados -->
        <div class="no-enviados-section" id="noEnviadosSection" style="display: none;">
          <div class="no-enviados-title">No Enviados (Pendientes de Retiro)</div>
          <table class="no-enviados-table">
            <thead>
              <tr>
                <th>Local</th>
                <th>Fecha Caja</th>
                <th>Monto</th>
                <th>D√≠as Transcurridos</th>
              </tr>
            </thead>
            <tbody id="noEnviadosBody">
              <!-- Se llenar√° din√°micamente -->
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
  <script>
// Variable global para almacenar los datos del reporte
let datosGlobales = {};

document.addEventListener('DOMContentLoaded', function() {
    // Inicializar fecha selector con fecha actual
    const fechaInput = document.getElementById('fechaConsulta');
    const hoy = new Date();
    fechaInput.value = hoy.toISOString().split('T')[0];

    // Cargar datos iniciales
    cargarResumenTesoreria();

    // Evento click bot√≥n actualizar
    document.getElementById('btnActualizar').addEventListener('click', function() {
        cargarResumenTesoreria();
    });

    // Tambi√©n permitir actualizar con Enter en el input de fecha
    fechaInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            cargarResumenTesoreria();
        }
    });
});

async function cargarResumenTesoreria() {
    const loadingSpinner = document.getElementById('loadingSpinner');
    const errorContainer = document.getElementById('errorContainer');
    const dataContainer = document.getElementById('dataContainer');
    const dateIndicator = document.getElementById('dateIndicator');
    const noEnviadosSection = document.getElementById('noEnviadosSection');

    try {
        const fechaSeleccionada = document.getElementById('fechaConsulta').value;
        const url = `/api/operaciones/ap-efectivo${fechaSeleccionada ? '?fecha=' + fechaSeleccionada : ''}`;

        const response = await fetch(url);
        const data = await response.json();

        if (!data.success) {
            throw new Error(data.msg || 'Error al cargar datos');
        }

        loadingSpinner.style.display = 'none';
        dataContainer.style.display = 'block';

        // Guardar datos globalmente para PDF
        datosGlobales = {
            segmentos: data.segmentos,
            datos: data.datos,
            fechas: data.fechas,
            fechas_full: data.fechas_full,
            es_lunes: data.es_lunes,
            no_enviados: data.no_enviados
        };

        // Actualizar indicador de fecha
        if (data.es_lunes) {
            dateIndicator.textContent = 'üìÖ Fin de Semana';
            dateIndicator.style.background = '#6b7280';
        } else {
            dateIndicator.textContent = 'üìÖ D√≠a: ' + data.fechas[0];
            dateIndicator.style.background = '#6b7280';
        }

        // Renderizar segmentos
        renderizarSegmentos(data);

        // Renderizar No Enviados
        renderizarNoEnviados(data.no_enviados);

    } catch (error) {
        console.error('‚ùå Error:', error);
        loadingSpinner.style.display = 'none';
        errorContainer.style.display = 'block';
        errorContainer.innerHTML = `<div class="error-message">‚ùå ${error.message}</div>`;
    }
}

function renderizarSegmentos(data) {
    const dataContainer = document.getElementById('dataContainer');
    dataContainer.innerHTML = '';

    const esLunes = data.es_lunes || false;

    data.segmentos.forEach((segmento, idx) => {
        const segmentDiv = document.createElement('div');
        segmentDiv.className = 'segment-section';

        const segmentTitle = document.createElement('div');
        segmentTitle.className = 'segment-title';
        segmentTitle.textContent = `Fecha: ${data.fechas_full[0]} - Locales: ${segmento.nombre}`;

        const table = crearTablaSegmento(segmento, data.fechas, data.datos, esLunes);

        segmentDiv.appendChild(segmentTitle);
        segmentDiv.appendChild(table);
        dataContainer.appendChild(segmentDiv);
    });
}

function crearTablaSegmento(segmento, fechas, datosGlobal, esLunes) {
    const table = document.createElement('table');
    table.className = 'data-table';

    // Crear thead
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');

    // Columna Local
    const thLocal = document.createElement('th');
    thLocal.className = 'local-header';
    thLocal.textContent = 'Locales';
    headerRow.appendChild(thLocal);

    // Columna Saldo anterior (antes de las fechas)
    const thSaldoAnterior = document.createElement('th');
    thSaldoAnterior.className = 'saldo-header';
    thSaldoAnterior.textContent = 'Saldo anterior';
    headerRow.appendChild(thSaldoAnterior);

    // Columnas de fechas
    fechas.forEach(fecha => {
        const thFecha = document.createElement('th');
        thFecha.className = 'date-header';
        thFecha.colSpan = 1;  // Solo "Efectivo", no m√°s Real y Dif
        thFecha.textContent = fecha;
        headerRow.appendChild(thFecha);
    });

    // Columna Total FDS (solo si es lunes)
    if (esLunes) {
        const thTotal = document.createElement('th');
        thTotal.className = 'saldo-header';
        thTotal.textContent = 'Total FDS';
        headerRow.appendChild(thTotal);
    }

    // Orden final: AP Proyectada PRIMERO, Saldo a Retirar al final (√∫ltima columna)
    const thAp = document.createElement('th');
    thAp.className = 'saldo-header';
    thAp.textContent = 'Ap Proyectada';
    headerRow.appendChild(thAp);

    const thSaldo = document.createElement('th');
    thSaldo.className = 'saldo-header';
    thSaldo.textContent = 'Saldo a retirar';
    headerRow.appendChild(thSaldo);

    thead.appendChild(headerRow);

    // Segunda fila de encabezados (Te√≥rico, Real, Dif.)
    const subHeaderRow = document.createElement('tr');
    const thLocalEmpty = document.createElement('th');
    thLocalEmpty.className = 'local-header';
    thLocalEmpty.textContent = '';
    subHeaderRow.appendChild(thLocalEmpty);

    // Espacio vac√≠o para columna Saldo anterior
    const thSaldoAnteriorEmpty = document.createElement('th');
    thSaldoAnteriorEmpty.className = 'saldo-header';
    thSaldoAnteriorEmpty.textContent = '';
    subHeaderRow.appendChild(thSaldoAnteriorEmpty);

    fechas.forEach(() => {
        const thEfectivo = document.createElement('th');
        thEfectivo.textContent = 'Efectivo';
        subHeaderRow.appendChild(thEfectivo);
    });

    if (esLunes) {
        const thTotalEmpty = document.createElement('th');
        thTotalEmpty.className = 'saldo-header';
        thTotalEmpty.textContent = '';
        subHeaderRow.appendChild(thTotalEmpty);
    }

    // Espacios vac√≠os para AP Proyectada y Saldo a Retirar (sin sub-headers)
    const thApEmpty = document.createElement('th');
    thApEmpty.className = 'saldo-header';
    thApEmpty.textContent = '';
    subHeaderRow.appendChild(thApEmpty);

    const thSaldoEmpty = document.createElement('th');
    thSaldoEmpty.className = 'saldo-header';
    thSaldoEmpty.textContent = '';
    subHeaderRow.appendChild(thSaldoEmpty);

    thead.appendChild(subHeaderRow);
    table.appendChild(thead);

    // Crear tbody
    const tbody = document.createElement('tbody');

    segmento.locales.forEach(local => {
        const row = document.createElement('tr');

        // Columna nombre local
        const tdLocal = document.createElement('td');
        tdLocal.className = 'local-name';
        tdLocal.textContent = local;
        row.appendChild(tdLocal);

        const datosLocal = datosGlobal[local] || {};

        // Saldo Anterior (acumulado hist√≥rico) - DESPU√âS de Local, ANTES de fechas
        const tdSaldoAnterior = document.createElement('td');
        tdSaldoAnterior.className = 'amount saldo-anterior-value';
        tdSaldoAnterior.textContent = formatearMonto(datosLocal.saldo_anterior || 0);
        row.appendChild(tdSaldoAnterior);

        let totalFDS = 0;

        // Columnas de fechas
        fechas.forEach(fecha => {
            const datosFecha = datosLocal[fecha] || { efectivo: 0 };
            totalFDS += datosFecha.efectivo;

            const tdEfectivo = document.createElement('td');
            tdEfectivo.className = 'amount teorico-value';
            tdEfectivo.textContent = formatearMonto(datosFecha.efectivo);
            row.appendChild(tdEfectivo);
        });

        // Total FDS (solo si es lunes)
        if (esLunes) {
            const tdTotalFDS = document.createElement('td');
            tdTotalFDS.className = 'amount';
            tdTotalFDS.textContent = formatearMonto(totalFDS);
            row.appendChild(tdTotalFDS);
        }

        // Calcular AP Proyectada = Saldo Anterior + Efectivo - Saldo a Retirar
        const saldoAnterior = datosLocal.saldo_anterior || 0;
        const saldoARetirar = datosLocal.saldo_a_retirar || 0;
        const apProyectada = saldoAnterior + totalFDS - saldoARetirar;

        // Orden final: AP Proyectada PRIMERO (con negrita), Saldo a Retirar al final
        const tdApProyectada = document.createElement('td');
        tdApProyectada.className = 'amount ap-proyectada-value';
        tdApProyectada.style.fontWeight = 'bold';  // Negrita para destacar
        tdApProyectada.textContent = formatearMonto(apProyectada);
        row.appendChild(tdApProyectada);

        const tdSaldo = document.createElement('td');
        tdSaldo.className = 'amount saldo-value';
        tdSaldo.textContent = formatearMonto(saldoARetirar);
        row.appendChild(tdSaldo);

        tbody.appendChild(row);
    });

    table.appendChild(tbody);
    return table;
}

function renderizarNoEnviados(noEnviados) {
    const noEnviadosSection = document.getElementById('noEnviadosSection');
    const noEnviadosBody = document.getElementById('noEnviadosBody');

    // Filtrar Local_Test
    const noEnviadosFiltrados = (noEnviados || []).filter(item => item.local !== 'Local_Test');

    if (noEnviadosFiltrados.length === 0) {
        noEnviadosBody.innerHTML = '<tr><td colspan="4" class="empty-message">‚úÖ No hay remesas pendientes de retiro</td></tr>';
    } else {
        noEnviadosBody.innerHTML = '';

        noEnviadosFiltrados.forEach(item => {
            const row = document.createElement('tr');

            const tdLocal = document.createElement('td');
            tdLocal.className = 'local-col';
            tdLocal.textContent = item.local;
            row.appendChild(tdLocal);

            const tdFecha = document.createElement('td');
            tdFecha.textContent = formatearFecha(item.fecha_caja);
            row.appendChild(tdFecha);

            const tdMonto = document.createElement('td');
            tdMonto.className = 'monto-col';
            tdMonto.textContent = formatearMonto(item.monto);
            row.appendChild(tdMonto);

            const tdDias = document.createElement('td');
            tdDias.className = 'dias-col';
            tdDias.textContent = item.dias_transcurridos + ' d√≠a' + (item.dias_transcurridos !== 1 ? 's' : '');
            row.appendChild(tdDias);

            noEnviadosBody.appendChild(row);
        });
    }

    noEnviadosSection.style.display = 'block';
}

function formatearMonto(valor) {
    if (!valor || valor === 0) return '-';
    return '$' + Math.round(parseFloat(valor)).toLocaleString('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}

function formatearFecha(fechaStr) {
    if (!fechaStr) return '-';
    const fecha = new Date(fechaStr);
    const dia = String(fecha.getDate()).padStart(2, '0');
    const mes = String(fecha.getMonth() + 1).padStart(2, '0');
    const a√±o = fecha.getFullYear();
    return `${dia}/${mes}/${a√±o}`;
}

// Funci√≥n para generar PDF (id√©ntico al dise√±o web)
function generarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape', 'mm', 'a4');

    // T√≠tulo
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('AP Efectivo', 148, 12, { align: 'center' });

    // Fecha del reporte
    const fechaIndicador = document.getElementById('dateIndicator').textContent;
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(fechaIndicador, 148, 18, { align: 'center' });

    let yPos = 25;

    const segmentos = datosGlobales.segmentos;
    const datos = datosGlobales.datos;
    const fechas = datosGlobales.fechas;
    const fechas_full = datosGlobales.fechas_full;
    const esLunes = datosGlobales.es_lunes;

    segmentos.forEach((segmento, segIdx) => {
        // Calcular ancho total de la tabla para centrar el t√≠tulo
        const anchoTotalTabla = 45 + 25 + (fechas.length * 22) + (esLunes ? 22 : 0) + 28 + 28;
        const margenIzq = (297 - anchoTotalTabla) / 2;

        // T√≠tulo del segmento (con fondo gris #d1d5db como en la web, centrado)
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.setFillColor(209, 213, 219); // #d1d5db
        doc.setTextColor(31, 41, 55); // #1f2937
        doc.rect(margenIzq, yPos - 4, anchoTotalTabla, 5, 'F');
        doc.text(`Fecha: ${fechas_full[0]} - Locales: ${segmento.nombre}`, margenIzq + 1, yPos);
        yPos += 3;

        // Preparar headers - PRIMERA FILA
        const numFechas = fechas.length;
        const numColumnas = 2 + numFechas + (esLunes ? 1 : 0) + 2; // Local, Saldo anterior, fechas, Total FDS?, AP, Saldo

        // Calcular anchos de columna (ajustados para fin de semana)
        // Si es fin de semana (3 fechas), reducir anchos para que entre todo
        const anchoLocal = esLunes ? 38 : 45;
        const anchoSaldoAnt = esLunes ? 22 : 25;
        const anchoFecha = esLunes ? 18 : 22;
        const anchoTotalFDS = esLunes ? 20 : 22;
        const anchoAP = esLunes ? 24 : 28;
        const anchoSaldo = esLunes ? 24 : 28;

        // PRIMERA FILA DE HEADERS
        const headers1 = [
            { content: 'Locales', rowSpan: 2, styles: { halign: 'left', fontStyle: 'bold', cellWidth: anchoLocal } },
            { content: 'Saldo anterior', rowSpan: 2, styles: { halign: 'center', fontStyle: 'bold', cellWidth: anchoSaldoAnt } }
        ];

        fechas.forEach(f => {
            headers1.push({ content: f, colSpan: 1, styles: { halign: 'center', fontStyle: 'bold', cellWidth: anchoFecha } });
        });

        if (esLunes) {
            headers1.push({ content: 'Total FDS', rowSpan: 2, styles: { halign: 'center', fontStyle: 'bold', cellWidth: anchoTotalFDS } });
        }

        headers1.push({ content: 'Ap Proyectada', rowSpan: 2, styles: { halign: 'center', fontStyle: 'bold', cellWidth: anchoAP } });
        headers1.push({ content: 'Saldo a retirar', rowSpan: 2, styles: { halign: 'center', fontStyle: 'bold', cellWidth: anchoSaldo } });

        // SEGUNDA FILA DE HEADERS (sub-headers)
        const headers2 = ['', '']; // Vac√≠os para Local y Saldo anterior
        fechas.forEach(() => {
            headers2.push('Efectivo');
        });
        if (esLunes) headers2.push('');
        headers2.push('', ''); // Vac√≠os para AP y Saldo

        // Preparar rows
        const rows = [];
        segmento.locales.forEach(local => {
            const datosLocal = datos[local] || {};
            const row = [
                { content: local, styles: { halign: 'left', fontStyle: 'normal' } },
                { content: formatearMonto(datosLocal.saldo_anterior || 0), styles: { halign: 'center', fontStyle: 'normal' } }
            ];

            let totalFDS = 0;
            fechas.forEach(fecha => {
                const datosFecha = datosLocal[fecha] || { efectivo: 0 };
                totalFDS += datosFecha.efectivo;
                row.push({ content: formatearMonto(datosFecha.efectivo), styles: { halign: 'center', fontStyle: 'normal' } });
            });

            if (esLunes) {
                row.push({ content: formatearMonto(totalFDS), styles: { halign: 'center', fontStyle: 'normal' } });
            }

            const saldoAnterior = datosLocal.saldo_anterior || 0;
            const saldoARetirar = datosLocal.saldo_a_retirar || 0;
            const apProyectada = saldoAnterior + totalFDS - saldoARetirar;

            // AP Proyectada con fondo gris #e5e7eb
            row.push({
                content: formatearMonto(apProyectada),
                styles: { halign: 'center', fontStyle: 'bold', fillColor: [229, 231, 235] } // #e5e7eb
            });

            row.push({ content: formatearMonto(saldoARetirar), styles: { halign: 'center', fontStyle: 'bold' } });

            rows.push(row);
        });

        // Generar tabla con jsPDF-AutoTable
        doc.autoTable({
            head: [headers1, headers2],
            body: rows,
            startY: yPos,
            theme: 'grid',
            margin: { left: margenIzq }, // Centrar en p√°gina landscape usando el mismo margen del t√≠tulo
            tableWidth: 'auto',
            styles: {
                fontSize: 10,
                cellPadding: 2,
                lineColor: [209, 213, 219], // #d1d5db
                lineWidth: 0.1,
                textColor: [0, 0, 0],
                halign: 'center'
            },
            headStyles: {
                fillColor: [209, 213, 219], // #d1d5db (fondo gris claro)
                textColor: [75, 85, 99], // #4b5563 (texto gris oscuro)
                fontStyle: 'bold',
                fontSize: 10,
                lineColor: [156, 163, 175], // #9ca3af
                lineWidth: 0.2
            },
            bodyStyles: {
                fillColor: [255, 255, 255],
                textColor: [0, 0, 0]
            },
            alternateRowStyles: {
                fillColor: [255, 255, 255]
            }
        });

        yPos = doc.lastAutoTable.finalY + 6;

        // Si no cabe en la p√°gina, crear nueva
        if (yPos > 175 && segIdx < segmentos.length - 1) {
            doc.addPage();
            yPos = 20;
        }
    });

    // Secci√≥n "No Enviados" (filtrar Local_Test)
    const noEnviados = (datosGlobales.no_enviados || []).filter(item => item.local !== 'Local_Test');
    if (noEnviados.length > 0) {
        if (yPos > 160) {
            doc.addPage();
            yPos = 20;
        }

        // Calcular ancho de tabla No Enviados y centrar
        const anchoTablaNoEnviados = 60 + 35 + 35 + 45; // 175mm total
        const margenNoEnviados = (297 - anchoTablaNoEnviados) / 2;

        // T√≠tulo con fondo gris #d1d5db (centrado)
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.setFillColor(209, 213, 219);
        doc.setTextColor(31, 41, 55);
        doc.rect(margenNoEnviados, yPos - 4, anchoTablaNoEnviados, 5, 'F');
        doc.text('No Enviados (Pendientes de Retiro)', margenNoEnviados + 1, yPos);
        yPos += 3;

        const noEnviadosHeaders = ['Local', 'Fecha Caja', 'Monto', 'D√≠as Transcurridos'];
        const noEnviadosRows = noEnviados.map(item => [
            { content: item.local, styles: { halign: 'left' } },
            { content: formatearFecha(item.fecha_caja), styles: { halign: 'center' } },
            { content: formatearMonto(item.monto), styles: { halign: 'right' } },
            { content: `${item.dias_transcurridos} d√≠a${item.dias_transcurridos !== 1 ? 's' : ''}`, styles: { halign: 'center', textColor: [220, 38, 38] } } // #dc2626
        ]);

        doc.autoTable({
            head: [noEnviadosHeaders],
            body: noEnviadosRows,
            startY: yPos,
            theme: 'grid',
            margin: { left: margenNoEnviados }, // Centrar tabla No Enviados usando el mismo margen del t√≠tulo
            styles: {
                fontSize: 10,
                cellPadding: 2,
                lineColor: [209, 213, 219],
                lineWidth: 0.1,
                textColor: [0, 0, 0]
            },
            headStyles: {
                fillColor: [209, 213, 219], // #d1d5db (igual que las tablas principales)
                textColor: [75, 85, 99], // #4b5563
                fontStyle: 'bold',
                fontSize: 10,
                lineColor: [156, 163, 175],
                lineWidth: 0.2
            },
            columnStyles: {
                0: { cellWidth: 60 },
                1: { cellWidth: 35 },
                2: { cellWidth: 35 },
                3: { cellWidth: 45 }
            }
        });
    }

    // Descargar PDF
    const fechaArchivo = document.getElementById('fechaConsulta').value || new Date().toISOString().split('T')[0];
    doc.save(`AP_Efectivo_${fechaArchivo}.pdf`);
}

// Event listener para el bot√≥n de descarga
document.getElementById('btnDescargarPDF').addEventListener('click', generarPDF);

  </script>
</body>
</html>
